---
title: "Example6-1-1"
author: "Hwang Seong-Yun"
date: '2020 12 11 '
output: html_document
---

### 필요 패키지 

```{r}
library(tidyverse)
library(mgcv)
library(ggplot2)
library(gridExtra)
library(moonBook)
library(ztable)
library(survival)
library(ggGam)
library(corrplot)
library(ggcorrplot)
library(car)
library(lmtest)
library(fda)
library(refund)
library(MASS)
library(boot)
library(kohonen)
library(SOMbrero)
library(e1071)
# par(mar=c(4,4,4,4))
# par(oma=c(0.5,0.5,0.5,0.5))
```

#### 다중선형회귀모형 적용 시 Chla의 예측값이 음수가 나오는 경우가 발생할 수 있음. 이에 따라 변수의 특성에 맞는 분포를 가정해서 모형을 적합할 필요가 있음.

#### TC, FC의 경우 변동이 크고 이상치가 있다는 특성을 감안하여 설명변수로 사용 시 log변환을 실시함.

#### 변수 time은 2010년 1월 1일 기준으로 경과된 날짜를 계산하여 반영함.

#### 모형의 설명력은 Deviance explained(다양한 형태의 모형을 비교하기 위해 R-square 통계량을 확장한 형태) 통계량 기준으로(산출된 값이 클수록 좋음.), 모형의 예측력은 RMSE(Root Mean Squared Error) 통계량 기준으로 해석함(산출된 값이 작을수록 좋음.).
- $RMSE= \sqrt{\frac {1}  {n} \sum _{i=1} ^{n} (y _{i} - {\hat{y _{i}}} ) ^{2}}$ , $D.E= 1- \frac {residual D.E} {null D.E} $

#### 환경데이터에서는 분산이 평균보다 큰 과분포(overdispersion) 현상이 자주 발생함. 이에 따라 GAM, TVCM 모형에 대해서는 Quasi Distribution을 추가로 적용함.

#### Chla의 경우는 오른쪽으로 꼬리가 긴 분포적 특성이 있고 양의 실수값만을 가지므로(positive real number) GLM, GAM, TVCM 적용 시 기본적으로 감마분포를 적용하지만 그 분포의 형태를 확실히 규정짓기 어려우므로 다음과 같이 분포를 가정함. -> GLM : Gamma / GAM, TVCM : Gamma, quasi

#### Poisson Distribution : https://en.wikipedia.org/wiki/Poisson_distribution 

#### Gamma Distribution : https://en.wikipedia.org/wiki/Gamma_distribution

#### Quasi Distribution : https://en.wikipedia.org/wiki/Quasiprobability_distribution, https://m.blog.naver.com/jinp7/222041237039

#### Quasi 분포는 과분포(overdispersion) 현상이 있거나 분포를 규정짓기 어려운 경우에 적용할 수 있음. 


### 이론 정리

#### 1. Spearman Correlation Analysis
- 일반적으로 사용되는 Pearson Correlation Analysis는 기본적으로 정규분포(Normal Distribution)을 가정하기 때문에 다양한 분포적 특성과 이상치(Outlier)가 존재하는 환경데이터의 경우에는 각 변수에 대해 오름차순으로 매긴 순위를 사용하는 Spearman Correlation Analysis가 타당하다고 판단됨.
- https://bioinformaticsandme.tistory.com/58
- Spearman Correlation Coefficient : $r _{s} = \frac {{\sum _{j=1} ^{n} (r _{xj} - {\bar{r _{x}}} )(r _{yj} - {\bar{r _{y}}} )}}  {\sqrt {\sum _{j=1} ^{n} (r _{xj} - {\bar{r _{x}}} ) ^{2} \sum _{j=1} ^{n} (r _{yj} - {\bar{r _{y}}} ) ^{2}}} =1- \frac {{6} \sum _{j=1} ^{n} (r _{xj} -r _{yj} ) ^{2}}  {n(n ^{2} -1)} $
- Z test : $Z= \frac {r _{s}} {\sqrt {\frac {1}  {n-1}}} -> N(0,1)$ if  $n>=10$
- Reject $H_{0}$ if $|Z|>=z_{\frac \alpha {2}}$
- T test : $T= \frac {r _{s} \sqrt {n-2}} {\sqrt {1-r _{s}^{2}}} -> t _{n-2}$ if $n >= 20$
- Reject $H_{0}$ if $|T|>=t_{\frac \alpha {2}}(n-2)$  

#### 2. SOM(Self Organizing Map)
- 차원축소(dimensionality reduction)와 군집화(clustering)를 동시에 수행하는 기법
- https://untitledtblog.tistory.com/5
- 1) 가중치 행렬 각 원소의 값을 임의의 0보다 크고 1보다 작은 값으로 초기화.
- 2-1) 입력 벡터와 경쟁층에 존재하는 $j$개의 노드에 대해 입력 벡터와 노드 간의 거리 $D_{ij}$를 계산.
- 2-2) 현재 입력 벡터와 $D_{ij}$값이 가장 작은 경쟁층의 노드를 선택.
- 2-3) 해당 노드의 가중치와 이웃 노드의 가중치를 수정.
- 3) 현재 입력 벡터가 마지막 입력 벡터라면 다음 과정으로 이동하고, 그렇지 않다면 과정 2로 돌아간다.
- 4-1) 현재 반복 횟수가 최대 반복 횟수라면 알고리즘을 종료.
- 4-2) 현재 반복 횟수가 최대 반복 횟수가 아니면 현재 입력 벡터를 처음 입력 벡터로 설정하고 과정 2로 돌아간다.
- $D _{ij} = \sum _{i=1} ^{n} (w _{ij} -x _{i} ) ^{2}$
- $w _{ij} =w _{ij} (old)+ \alpha (t)(x _{i} -w _{ij} (old))$

#### 3. 다중선형회귀분석(Multiple Linear Regression Analysis)
- 반응변수와 설명변수와의 관계를 살펴보고자 할 때 가장 간단하게 사용할 수 있는 통계적 모형
- $y _{i} = \beta  _{0} + \beta  _{1} x _{1i} + \beta  _{2} x _{2i} +...+ \beta  _{p} x _{pi} + \epsilon  _{i} ,$
$\epsilon  _{i} ->i.i.d  N(0, \sigma  ^{2} ) , i=1,2,...,n$
- Normal Distribution : $X -> N( \mu , \sigma  ^{2} ) --> f _{X} (x)= \frac{1} {\sqrt {2 \pi } \sigma } exp (  - \frac{1}  {2 \sigma  ^{2}} (x- \mu ) ^{2}) , x \in R $

#### 4. 일반화선형모형(Generalized Linear Model)
- https://seoncheolpark.github.io/book/_book/14-1-glm-basics.html
- https://zephyrus1111.tistory.com/26
- 다중선형회귀분석은 기본적으로 반응변수의 분포가 정규분포(Normal Distribution)임을 가정한다. 그러나 TC, FC 같은 대장균수는 셀 수 있는 변수(counting variable)이고 Chl-a는 양의 실수값이면서 일반적으로 오른쪽으로 꼬리가 긴 분포를 보인다. 이처럼 데이터 내의 반응변수가 항상 정규분포라고 말할 수는 없기 때문에 분포적 특성에 맞는 선형모형을 확장하여 생각한 것이 일반화선형모형이다.
- $g[E(y )]= \beta  _{0} + \beta  _{1} x _{1} + \beta  _{2} x _{2} +...+ \beta  _{p} x _{p}$
- Poisson Distribution : $X -> Poisson( \lambda )-->P _{X} (X=x)=\frac {e ^{- \lambda } \lambda  ^{x}}  {x!} , x=0,1,2,3,...$
- Gamma Distribution : $X->Gamma ( \alpha , \beta )-->f _{X} (x)= \frac{1}  {\gamma ( \alpha ) \beta  ^{\alpha }} x ^{\alpha -1} e ^{-\frac {1}  {\beta }} , x>0$
- $\gamma ( \alpha )= \int _{0} ^{INF } {x ^{\alpha -1} e ^{-x} dx,x>0}$
- Binomial Distribution : $X -> B(p) --> P _{X} (X=x)= _{n} C _{x} p ^{x} (1-p) ^{n-x} , x=0,1,2,...,n$
- Log Poisson Model(포아송분포 가정) : $log(y)= \beta  _{0} + \beta  _{1} x _{1} + \beta  _{2} x _{2} +...+ \beta  _{p} x _{p}$
- Log Gamma Model(감마분포 가정) : $log(y)= \beta  _{0} + \beta  _{1} x _{1} + \beta  _{2} x _{2} +...+ \beta  _{p} x _{p}$
- Logistic Model(2개의 집단일 경우 이항분포 가정) : $log(\frac {prob }  {1-prob} )= \beta  _{0} + \beta  _{1} x _{1} + \beta  _{2} x _{2} +...+ \beta  _{p} x _{p}$
- 이외에도 다양한 모형이 존재함.

#### 5. 일반화가법모형(Generalized Additive Model), 시간에 따른 계수변화모형(Time Varying Coefficient Model)
- 일반화가법모형 : 일반화선형모형의 확장으로 반응변수와 설명변수간의 비선형(Non-linear relationship)관계를 고려한 모형.
- 선형회귀와 같은 단순한 모형은 사용하기 쉽고 해석하기 쉬우며 인수의 뜻도 해석하기 쉽다. 하지만 선형관계로 설명할 수 없는 현상을 설명하려면 보다 복잡한 모형이 필요하다. 신경망과 같은 기계학습 모형은 복잡한 관계를 예측하는 능력은 뛰어나지만 많은 데이터를 필요로 하고 해석하기 어렵고 모형의 결과로부터 추론하는 것이 매우 어렵다. GAM은 선형모형과 기계학습의 중간에 위치하고 있다. 복잡한 비선형관계를 적합시킬 수 있으며 매우 좋은 예측을 할 수 있는 반면 통계적 추론이 가능할 뿐만 아니라 모형의 구조를 이해하고 설명할 수 있으며 예측에 대한 설명도 가능하다.
- https://bookdown.org/cardiomoon/gam/-.html#tab-1
- $g[E(y)]= \beta  _{0} +f _{1} (x _{1} )+f _{2} (x _{2} )+...+f _{p} (x _{p} )$
- Log Poisson Model(포아송분포 가정) : $log(y)= \beta  _{0} +f _{1} (x _{1} )+f _{2} (x _{2} )+...+f _{p} (x _{p} )$ 
- Log Gamma Model(감마분포 가정) : $log(y)= \beta  _{0} +f _{1} (x _{1} )+f _{2} (x _{2} )+...+f _{p} (x _{p} )$
- Logistic Model(2개의 집단일 경우 이항분포 가정) : $log(\frac {p }  {1-p} )= \beta  _{0} +f _{1} (x _{1} )+f _{2} (x _{2} )+...+f _{p} (x _{p} )$
- Log Quasi Model : $log(y)= \beta  _{0} +f _{1} (x _{1} )+f _{2} (x _{2} )+...+f _{p} (x _{p} )$  
- 이외에도 다양한 모형이 존재함.
- 시간에 따른 계수변화모형 : 역시 일반화선형모형의 확장으로 시간에 의존하는 변수의 특성을 감안하여 계수가 시간에 따라 변화한다고 가정한 모형.
- $g[E(y)]= \beta  _{0} (t)+ \beta  _{1} (t)x _{1} + \beta  _{2} (t)x _{2} +...+ \beta  _{p} (t)x _{p}$
- Log Poisson Model(포아송분포 가정) : $log(y)= \beta  _{0} (t)+ \beta  _{1} (t)x _{1} + \beta  _{2} (t)x _{2} +...+ \beta  _{p} (t)x _{p}$
- Log Gamma Model(감마분포 가정) : $log(y)= \beta  _{0} (t)+ \beta  _{1} (t)x _{1} + \beta  _{2} (t)x _{2} +...+ \beta  _{p} (t)x _{p}$
- Logistic Model(2개의 집단일 경우 이항분포 가정) : $log(\frac {p }  {1-p} )= \beta  _{0} (t)+ \beta  _{1} (t)x _{1} + \beta  _{2} (t)x _{2} +...+ \beta  _{p} (t)x _{p}$
- Log Quasi Model : $log(y)= \beta  _{0} (t)+ \beta  _{1} (t)x _{1} + \beta  _{2} (t)x _{2} +...+ \beta  _{p} (t)x _{p}$ 

#### 6. 변수선택(Variable Selection)
- Multiple Linear Regression Analysis, Generalized Linear Model : 보통 AIC(Akaike's Information Criterion) 통계량을 기준으로 변수선택을 한다. AIC의 값이 작을수록 바람직한 모형임을 의미한다.
- $AIC=-2ln( {\hat{L}} )+2p$
- Generalized Additive Model, Time Varying Coefficient Model : 벌점함수(penalty function)를 바탕으로 GCVC(Generalized Cross-Validation Criterion) (unknown scale parameter) or Mallow’s Cp Statistic (known scale parameter) 기준 축소변수선택(Shrinkage variable selection)방법을 적용한다. GCVC의 값 또는 Cp 통계량의 값이 작을수록 바람직한 모형이다. 
- $GCVC= \frac {nD}  {(n-DoF) ^{2}}$ 
- $C _{p} = \frac {SSE _{p}} {\sigma  ^{2}} +2p-n$

#### 7. 과적합(Overfitting)
- https://ko.wikipedia.org/wiki/%EA%B3%BC%EC%A0%81%ED%95%A9
- https://blog.naver.com/complusblog/221243306163
- 과적합(overfitting)은 기계 학습(machine learning)에서 학습 데이타를 과하게 학습(overfitting)하는 것을 뜻한다. 일반적으로 학습 데이터는 실제 데이터의 부분 집합이므로 학습데이터에 대해서는 오차가 감소하지만 실제데이터에 대해서는 오차가 증가하게 된다.
- 일반적으로 학습 데이터는 실제 데이터의 부분집합이며, 실제 데이터를 모두 수집하는 것은 불가능하다.
- 만약 실제 데이터를 모두 수집하여도 모든 데이터를 학습시키기 위한 시간이 측정 불가능한 수준으로 증가할 수 있다.
- 학습 데이터만 가지고 실제 데이터의 오차가 증가하는 지점을 예측하는 것은 매우 어렵거나 불가능하다.




### 사용데이터 : 광산 지점 데이터

#### 모니터링 기간 : 2010~2019년 (일별 주단위자료) 

#### 반응변수 : Chla

#### 설명변수 : BOD, COD, SS, TN, TP, TOC, TC, Flow, Rain (과적합을 완화시키기 위해 사용할 설명변수를 일부 취사선택하였고, TC의 경우는 변동이 크기 때문에 로그를 취하여 적용함.) 

#### 상관분석이나 모형적합 시 각 수질항목의 원값을 그대로 사용하여 표현하는 것이 모형의 설명력이나 예측력 비교 등의 측면에서 더 적절할 수 있다고 판단하여 표준화를 하지 않았음.




### Spearman Correlation Analysis

```{r}
ex1 <- read.csv("C:/Users/HSY/Desktop/광산(2010-2019).csv", sep=",", header=T)
ex1 <- ex1[,-1]
X1 <- round(cor(ex1[,-18], method='spearman'),4) 
corrplot(X1)
p.mat1 <- cor_pmat(ex1[,-18], method='spearman')
ggcorrplot(X1, hc.order=T, type="lower", lab=T) +
  ggtitle("Correlation plot(Spearman) for water quality data (Gwangsan)") +   
  theme(plot.title = element_text(family = "serif", 
                                  face = "bold", hjust = 0.5, 
                                  size = 15, color = "black"))
ggcorrplot(X1, hc.order=T, type="lower", p.mat=p.mat1) +
  ggtitle("Correlation plot(Spearman) for water quality data with significance level (Gwangsan)") +   
  theme(plot.title = element_text(family = "serif", 
                                  face = "bold", hjust = 0.5, 
                                  size = 15, color = "black"))
ex11 <- ex1[,c(3,4,5,6,7,8,11,14,16,17)]
X_11 <- round(cor(ex11, method='spearman'),4) 
corrplot(X_11)
p.mat1 <- cor_pmat(ex11, method='spearman')
ggcorrplot(X_11, hc.order=T, type="lower", lab=T) +
  ggtitle("Correlation plot(Spearman) for water quality data (Gwangsan)") +   
  theme(plot.title = element_text(family = "serif", 
                                  face = "bold", hjust = 0.5, 
                                  size = 15, color = "black"))
ggcorrplot(X_11, hc.order=T, type="lower", p.mat=p.mat1) +
  ggtitle("Correlation plot(Spearman) for water quality data with significance level (Gwangsan)") +   
  theme(plot.title = element_text(family = "serif", 
                                  face = "bold", hjust = 0.5, 
                                  size = 15, color = "black"))
```



### SOM(Self-Organizing Map) pattern

```{r}
ex1 <- read.csv("C:/Users/HSY/Desktop/광산(2010-2019).csv", sep=",", header=T)
ex1 <- ex1[,-1]
ex1 <- as.data.frame(ex1)
ex1_matrix <- as.matrix(ex1)
som_grid <- somgrid(xdim=17, ydim=30, topo="hexagonal")
som_model <- som(ex1_matrix, grid=som_grid)
coolBlueHotRed <- function(n, alpha=1) {rainbow(n, end=4/6, alpha=alpha)[n:1]}
par(mfrow=c(1,2))
for (i in 1:17) {
  plot(som_model, type="property", property=getCodes(som_model)[,i], 
       main=colnames(getCodes(som_model))[i], palette.name=coolBlueHotRed)}
par(mfrow=c(1,1))
```




### Dependent(Response) variable : Chla

### Multiple Linear Regression

```{r}
ex1 <- read.csv("C:/Users/HSY/Desktop/광산(2010-2019).csv", sep=",", header=T)
ex1 <- ex1[,-1]
ex1 <- as.data.frame(ex1)
ggplot(data=ex1,aes(x=pH,y=Chla)) + geom_point() + stat_smooth(method=lm)
ggplot(data=ex1,aes(x=DO,y=Chla)) + geom_point() + stat_smooth(method=lm)
ggplot(data=ex1,aes(x=BOD,y=Chla)) + geom_point() + stat_smooth(method=lm)
ggplot(data=ex1,aes(x=COD,y=Chla)) + geom_point() + stat_smooth(method=lm)
ggplot(data=ex1,aes(x=SS,y=Chla)) + geom_point() + stat_smooth(method=lm)
ggplot(data=ex1,aes(x=TN,y=Chla)) + geom_point() + stat_smooth(method=lm)
ggplot(data=ex1,aes(x=TP,y=Chla)) + geom_point() + stat_smooth(method=lm)
ggplot(data=ex1,aes(x=TOC,y=Chla)) + geom_point() + stat_smooth(method=lm)
ggplot(data=ex1,aes(x=WT,y=Chla)) + geom_point() + stat_smooth(method=lm)
ggplot(data=ex1,aes(x=EC,y=Chla)) + geom_point() + stat_smooth(method=lm)
ggplot(data=ex1,aes(x=TC,y=Chla)) + geom_point() + stat_smooth(method=lm)
ggplot(data=ex1,aes(x=NH3N,y=Chla)) + geom_point() + stat_smooth(method=lm)
ggplot(data=ex1,aes(x=PO4P,y=Chla)) + geom_point() + stat_smooth(method=lm)
ggplot(data=ex1,aes(x=FC,y=Chla)) + geom_point() + stat_smooth(method=lm)
ggplot(data=ex1,aes(x=Flow,y=Chla)) + geom_point() + stat_smooth(method=lm)
ggplot(data=ex1,aes(x=Rain,y=Chla)) + geom_point() + stat_smooth(method=lm)
fit <- glm(Chla~BOD+COD+SS+TN+TP+TOC+log(TC)+Flow+Rain,data=ex1,family=gaussian(link="identity"))
summary(fit) # Deviance explained: 0.5634      
vif(fit) 
par(mfrow=c(2,2))
plot(fit)
par(mfrow=c(1,1))
dwtest(Chla~BOD+COD+SS+TN+TP+TOC+log(TC)+Flow+Rain,data=ex1) # 잔차가 양의 자기상관성을 가지고 있음.
# 다중회귀분석에 대한 기본가정인 잔차(residual)에 대한 정규성, 등분산성, 독립성, 선형성 등을 만족하지 못함.
```

#### Stepwise variable selection with AIC(Akaike’s Information Criterion)

```{r}
fit.step <- stepAIC(fit, direction="both", trace=TRUE)
fit.step # 선택변수 : BOD, COD, SS, TN, TP, log(TC), Rain  
summary(fit.step) # Deviance explained: 0.5626       
vif(fit.step)  
par(mfrow=c(2,2))
plot(fit.step)
par(mfrow=c(1,1))
dwtest(Chla~BOD+COD+SS+TN+TP+log(TC)+Rain,data=ex1) # 잔차가 양의 자기상관성을 가지고 있음.
# 다중회귀분석에 대한 기본가정인 잔차(residual)에 대한 정규성, 등분산성, 독립성, 선형성 등을 만족하지 못함.
```

#### response vs fitted_values (train data (2010-2019))

```{r}
pred.mlr <- predict(fit.step,newdata=ex1,type="response")
data.mlr <- data.frame(response=ex1$Chla,fitted_values=pred.mlr,time=ex1$time)
sqrt(sum((data.mlr$response-data.mlr$fitted_values)^2)/length(data.mlr$response)) # RMSE = 22.13477    
ggplot(data.mlr, aes(x=response, y=fitted_values)) +
  geom_point() + geom_rug() +
  ggtitle("[Gwangsan Chla train data] response vs fitted_values (Multiple Linear Regression)") +
  geom_abline(intercept=0,slope=1,color='blue',size=1.5)
par(mfrow=c(1,1))
plot(data.mlr$time,data.mlr$response,type='o',col='blue',xlab="time",ylab="Chla",main="[Gwangsan Chla train data] response vs fitted_values (Multiple Linear Regression)",ylim=c(-100,500))
lines(data.mlr$time,data.mlr$fitted_values,type='o',col='red')
legend(0,500,c("fitted_values","response"),lwd=c(1,1),col=c("red","blue"))
```

#### response vs fitted_values (test data (2020))

```{r}
ex1_1 <- read.csv("C:/Users/HSY/Desktop/광산(2020).csv",sep=",",header=T)
ex1_1 <- ex1_1[,-1]
ex1_1 <- as.data.frame(ex1_1)
pred.mlr1 <- predict(fit.step,newdata=ex1_1,type="response")
data.mlr1 <- data.frame(response=ex1_1$Chla,fitted_values=pred.mlr1,time=ex1_1$time)
sqrt(sum((data.mlr1$response-data.mlr1$fitted_values)^2)/length(data.mlr1$response)) # RMSE = 46.53538     
ggplot(data.mlr1, aes(x=response, y=fitted_values)) +
  geom_point() + geom_rug() +
  ggtitle("[Gwangsan Chla test data] response vs fitted_values (Multiple Linear Regression)") +
  geom_abline(intercept=0,slope=1,color='blue',size=1.5)
par(mfrow=c(1,1))
plot(data.mlr1$time,data.mlr1$response,type='o',col='blue',xlab="time",ylab="Chla",main="[Gwangsan Chla test data] response vs fitted_values (Multiple Linear Regression)",ylim=c(-100,500))
lines(data.mlr1$time,data.mlr1$fitted_values,type='o',col='red')
legend(3650,500,c("fitted_values","response"),lwd=c(1,1),col=c("red","blue"))
```


### Generalized Linear Model (Gamma)

```{r}
m <- glm(Chla~BOD+COD+SS+TN+TP+TOC+log(TC)+Flow+Rain,data=ex1,family=Gamma(link="log"))
summary(m) # Deviance explained : 0.5397   
vif(m) 
par(mfrow=c(2,2))
plot(m)
par(mfrow=c(1,1))
```

#### Stepwise variable selection with AIC(Akaike’s Information Criterion)

```{r}
m.step <- stepAIC(m, direction="both", trace=TRUE)
m.step # 선택변수 : BOD, COD, SS, TN, TP, TOC, log(TC), Rain  
summary(m.step) # Deviance explained : 0.5391    
vif(m.step) # 다중공선성(multicollinearity) 존재 
par(mfrow=c(2,2))
plot(m.step)
par(mfrow=c(1,1))
```

#### response vs fitted_values (train data (2010-2019))

```{r}
pred.glm <- predict(m.step,newdata=ex1,type="response")
data.glm <- data.frame(response=ex1$Chla,fitted_values=pred.glm,time=ex1$time)
sqrt(sum((data.glm$response-data.glm$fitted_values)^2)/length(data.glm$response)) # RMSE = 31.8794     
ggplot(data.glm, aes(x=response, y=fitted_values)) +
  geom_point() + geom_rug() +
  ggtitle("[Gwangsan Chla train data] response vs fitted_values (Generalized Linear Model, (Gamma Distribution))") +
  geom_abline(intercept=0,slope=1,color='blue',size=1.5)
par(mfrow=c(1,1))
plot(data.glm$time,data.glm$response,type='o',col='blue',xlab="time",ylab="Chla",main="[Gwangsan Chla train data] response vs fitted_values (Generalized Linear Model, (Gamma Distribution))",ylim=c(-100,500))
lines(data.glm$time,data.glm$fitted_values,type='o',col='red')
legend(0,500,c("fitted_values","response"),lwd=c(1,1),col=c("red","blue"))
```

#### response vs fitted_values (test data (2020))

```{r}
ex1_1 <- read.csv("C:/Users/HSY/Desktop/광산(2020).csv",sep=",",header=T)
ex1_1 <- ex1_1[,-1]
ex1_1 <- as.data.frame(ex1_1)
pred.glm1 <- predict(m.step,newdata=ex1_1,type="response")
data.glm1 <- data.frame(response=ex1_1$Chla,fitted_values=pred.glm1,time=ex1_1$time)
sqrt(sum((data.glm1$response-data.glm1$fitted_values)^2)/length(data.glm1$response)) # RMSE = 52.70765  
ggplot(data.glm1, aes(x=response, y=fitted_values)) +
  geom_point() + geom_rug() +
  ggtitle("[Gwangsan Chla test data] response vs fitted_values (Generalized Linear Model, (Gamma Distribution))") +
  geom_abline(intercept=0,slope=1,color='blue',size=1.5)
par(mfrow=c(1,1))
plot(data.glm1$time,data.glm1$fitted_values,type='o',col='red',xlab="time",ylab="Chla",main="[Gwangsan Chla test data] response vs fitted_values (Generalized Linear Model, (Gamma Distribution))",ylim=c(-100,500))
lines(data.glm1$time,data.glm1$response,type='o',col='blue')
legend(3650,500,c("fitted_values","response"),lwd=c(1,1),col=c("red","blue"))
```


### Generalized Additive Model (Gamma)

```{r}
# GAM의 경우 추정되는 계수(coefficients)가 데이터의 개수보다 많으면 적합되지 않음.
mm <- gam(Chla~s(BOD)+s(COD)+s(SS)+s(TN)+s(TP)+s(TOC)+s(log(TC))+s(Flow)+s(Rain),data=ex1,family=Gamma(link="log"))
plot(mm,residuals=TRUE,pch=1,shade=TRUE,seWithMean=TRUE,shift=coef(mm)[1])
ggGam(mm)
summary(mm) # Deviance explained = 63.6%    
concurvity(mm,full=TRUE) 
par(mfrow=c(2,2))
gam.check(mm) # 적합결여 존재 (기저함수 부족)
par(mfrow=c(1,1))
```

#### Shrinkage variable selection with Generalized Cross-Validation Criterion or Mallow's Cp statistic

```{r}
mm.shrink <- gam(Chla~s(BOD)+s(COD)+s(SS)+s(TN)+s(TP)+s(TOC)+s(log(TC))+s(Flow)+s(Rain),data=ex1,family=Gamma(link="log"),method="GCV.Cp",select=TRUE) 
plot(mm.shrink,residuals=TRUE,pch=1,shade=TRUE,seWithMean=TRUE,shift=coef(mm.shrink)[1])
ggGam(mm.shrink) # 선택변수 : BOD, COD, SS, TN, TP, TOC, log(TC), Flow, Rain  
summary(mm.shrink) # Deviance explained = 63.3%    
concurvity(mm.shrink,full=TRUE) 
par(mfrow=c(2,2))
gam.check(mm.shrink) # 적합결여 존재 (기저함수 부족)
par(mfrow=c(1,1))
```

#### response vs fitted_values (train data (2010-2019))

```{r}
pred.gam <- predict(mm.shrink,newdata=ex1,type="response")
data.gam <- data.frame(response=ex1$Chla,fitted_values=pred.gam,time=ex1$time)
sqrt(sum((data.gam$response-data.gam$fitted_values)^2)/length(data.gam$response)) # RMSE = 22.63874      
ggplot(data.gam, aes(x=response, y=fitted_values)) +
  geom_point() + geom_rug() +
  ggtitle("[Gwangsan Chla train data] response vs fitted_values (Generalized Additive Model (Gamma Distribution))") +
  geom_abline(intercept=0,slope=1,color='blue',size=1.5)
par(mfrow=c(1,1))
plot(data.gam$time,data.gam$response,type='o',col='blue',xlab="time",ylab="Chla",main="[Gwangsan Chla train data] response vs fitted_values (Generalized Additive Model (Gamma Distribution))",ylim=c(-100,500))
lines(data.gam$time,data.gam$fitted_values,type='o',col='red')
legend(0,500,c("fitted_values","response"),lwd=c(1,1),col=c("red","blue"))
```

#### response vs fitted_values (test data (2020))

```{r}
ex1_1 <- read.csv("C:/Users/HSY/Desktop/광산(2020).csv",sep=",",header=T)
ex1_1 <- ex1_1[,-1]
ex1_1 <- as.data.frame(ex1_1)
pred.gam1 <- predict(mm.shrink,newdata=ex1_1,type="response")
data.gam1 <- data.frame(response=ex1_1$Chla,fitted_values=pred.gam1,time=ex1_1$time)
sqrt(sum((data.gam1$response-data.gam1$fitted_values)^2)/length(data.gam1$response)) # RMSE = 46.79092    
ggplot(data.gam1, aes(x=response, y=fitted_values)) +
  geom_point() + geom_rug() +
  ggtitle("[Gwangsan Chla test data] response vs fitted_values (Generalized Additive Model, (Gamma Distribution))") +
  geom_abline(intercept=0,slope=1,color='blue',size=1.5)
par(mfrow=c(1,1))
plot(data.gam1$time,data.gam1$fitted_values,type='o',col='red',xlab="time",ylab="Chla",main="[Gwangsan Chla test data] response vs fitted_values (Generalized Additive Model, (Gamma Distribution))",ylim=c(-100,500))
lines(data.gam1$time,data.gam1$response,type='o',col='blue')
legend(3650,500,c("fitted_values","response"),lwd=c(1,1),col=c("red","blue"))
```



### Generalized Additive Model (quasi)

```{r}
# GAM의 경우 추정되는 계수(coefficients)가 데이터의 개수보다 많으면 적합되지 않음.
mm <- gam(Chla~s(BOD)+s(COD)+s(SS)+s(TN)+s(TP)+s(TOC)+s(log(TC))+s(Flow)+s(Rain),data=ex1,family=quasi(link="log"))
plot(mm,residuals=TRUE,pch=1,shade=TRUE,seWithMean=TRUE,shift=coef(mm)[1])
ggGam(mm)
summary(mm) # Deviance explained = 65.9%   
concurvity(mm,full=TRUE) 
par(mfrow=c(2,2))
gam.check(mm) # 적합결여 존재 (기저함수 부족)
par(mfrow=c(1,1))
```

#### Shrinkage variable selection with Generalized Cross-Validation Criterion or Mallow's Cp statistic

```{r}
mm.shrink <- gam(Chla~s(BOD)+s(COD)+s(SS)+s(TN)+s(TP)+s(TOC)+s(log(TC))+s(Flow)+s(Rain),data=ex1,family=quasi(link="log"),method="GCV.Cp",select=TRUE) 
plot(mm.shrink,residuals=TRUE,pch=1,shade=TRUE,seWithMean=TRUE,shift=coef(mm.shrink)[1])
ggGam(mm.shrink) # 선택변수 : BOD, COD, SS, TN, TP, TOC, log(TC), Rain 
summary(mm.shrink) # Deviance explained = 66.2%   
concurvity(mm.shrink,full=TRUE) # 공선성 존재
par(mfrow=c(2,2))
gam.check(mm.shrink) # 적합결여 존재 (기저함수 부족)
par(mfrow=c(1,1))
```

#### response vs fitted_values (train data (2010-2019))

```{r}
pred.gam <- predict(mm.shrink,newdata=ex1,type="response")
data.gam <- data.frame(response=ex1$Chla,fitted_values=pred.gam,time=ex1$time)
sqrt(sum((data.gam$response-data.gam$fitted_values)^2)/length(data.gam$response)) # RMSE = 19.45662     
ggplot(data.gam, aes(x=response, y=fitted_values)) +
  geom_point() + geom_rug() +
  ggtitle("[Gwangsan Chla train data] response vs fitted_values (Generalized Additive Model (Quasi Distribution))") +
  geom_abline(intercept=0,slope=1,color='blue',size=1.5)
par(mfrow=c(1,1))
plot(data.gam$time,data.gam$response,type='o',col='blue',xlab="time",ylab="Chla",main="[Gwangsan Chla train data] response vs fitted_values (Generalized Additive Model (Quasi Distribution))",ylim=c(-100,500))
lines(data.gam$time,data.gam$fitted_values,type='o',col='red')
legend(0,500,c("fitted_values","response"),lwd=c(1,1),col=c("red","blue"))
```

#### response vs fitted_values (test data (2020))

```{r}
ex1_1 <- read.csv("C:/Users/HSY/Desktop/광산(2020).csv",sep=",",header=T)
ex1_1 <- ex1_1[,-1]
ex1_1 <- as.data.frame(ex1_1)
pred.gam1 <- predict(mm.shrink,newdata=ex1_1,type="response")
data.gam1 <- data.frame(response=ex1_1$Chla,fitted_values=pred.gam1,time=ex1_1$time)
sqrt(sum((data.gam1$response-data.gam1$fitted_values)^2)/length(data.gam1$response)) # RMSE = 45.85054   
ggplot(data.gam1, aes(x=response, y=fitted_values)) +
  geom_point() + geom_rug() +
  ggtitle("[Gwangsan Chla test data] response vs fitted_values (Generalized Additive Model, (Quasi Distribution))") +
  geom_abline(intercept=0,slope=1,color='blue',size=1.5)
par(mfrow=c(1,1))
plot(data.gam1$time,data.gam1$fitted_values,type='o',col='red',xlab="time",ylab="Chla",main="[Gwangsan Chla test data] response vs fitted_values (Generalized Additive Model, (Quasi Distribution))",ylim=c(-100,500))
lines(data.gam1$time,data.gam1$response,type='o',col='blue')
legend(3650,500,c("fitted_values","response"),lwd=c(1,1),col=c("red","blue"))
```


### Time Varying Coefficient Model (Gamma)

```{r}
vc <- gam(Chla~s(time)+s(time,by=BOD)+s(time,by=COD)+s(time,by=SS)+s(time,by=TN)+s(time,by=TP)+s(time,by=TOC)+s(time,by=log(TC))+s(time,by=Flow)+s(time,by=Rain),data=ex1,family=Gamma(link="log"))
plot(vc,residuals=TRUE,pch=1,shade=TRUE,seWithMean=TRUE,shift=coef(vc)[1],ylim=c(-40,40))
ggGam(vc)
summary(vc) # Deviance explained = 66.2%    
par(mfrow=c(2,2))
gam.check(vc) 
par(mfrow=c(1,1))
```

#### Shrinkage variable selection with Generalized Cross-Validation Criterion or Mallow's Cp statistic

```{r}
vc.shrink <- gam(Chla~s(time)+s(time,by=BOD)+s(time,by=COD)+s(time,by=SS)+s(time,by=TN)+s(time,by=TP)+s(time,by=TOC)+s(time,by=log(TC))+s(time,by=Flow)+s(time,by=Rain),data=ex1,family=Gamma(link="log"),method="GCV.Cp",select=TRUE)
plot(vc.shrink,residuals=TRUE,pch=1,shade=TRUE,seWithMean=TRUE,shift=coef(vc.shrink)[1],ylim=c(-40,40))
ggGam(vc.shrink) # 선택변수 : BOD, COD, SS, TN, TP, TOC, log(TC), Flow, Rain
summary(vc.shrink) # Deviance explained = 65.1%   
par(mfrow=c(2,2))
gam.check(vc.shrink) 
par(mfrow=c(1,1))
```

#### response vs fitted_values (train data (2010-2019))

```{r}
pred.tvcm <- predict(vc.shrink,newdata=ex1,type="response")
data.tvcm <- data.frame(response=ex1$Chla,fitted_values=pred.tvcm,time=ex1$time)
sqrt(sum((data.tvcm$response-data.tvcm$fitted_values)^2)/length(data.tvcm$response)) # RMSE = 29.30506     
ggplot(data.tvcm, aes(x=response, y=fitted_values)) +
  geom_point() + geom_rug() +
  ggtitle("[Gwangsan Chla train data] response vs fitted_values (Time Varying Coefficient Model, (Gamma Distribution))") +
  geom_abline(intercept=0,slope=1,color='blue',size=1.5)
par(mfrow=c(1,1))
plot(data.tvcm$time,data.tvcm$response,type='o',col='blue',xlab="time",ylab="Chla",main="[Gwangsan Chla train data] response vs fitted_values (Time Varying Coefficient Model, (Gamma Distribution))",ylim=c(-100,500))
lines(data.tvcm$time,data.tvcm$fitted_values,type='o',col='red')
legend(0,500,c("fitted_values","response"),lwd=c(1,1),col=c("red","blue"))
```

#### response vs fitted_values (test data (2020))

```{r}
ex1_1 <- read.csv("C:/Users/HSY/Desktop/광산(2020).csv",sep=",",header=T)
ex1_1 <- ex1_1[,-1]
ex1_1 <- as.data.frame(ex1_1)
pred.tvcm1 <- predict(vc.shrink,newdata=ex1_1,type="response")
data.tvcm1 <- data.frame(response=ex1_1$Chla,fitted_values=pred.tvcm1,time=ex1_1$time)
sqrt(sum((data.tvcm1$response-data.tvcm1$fitted_values)^2)/length(data.tvcm1$response)) # RMSE = 54.24671    
ggplot(data.tvcm1, aes(x=response, y=fitted_values)) +
  geom_point() + geom_rug() +
  ggtitle("[Gwangsan Chla test data] response vs fitted_values (Time Varying Coefficient Model, (Gamma Distribution))") +
  geom_abline(intercept=0,slope=1,color='blue',size=1.5)
par(mfrow=c(1,1))
plot(data.tvcm1$time,data.tvcm1$fitted_values,type='o',col='red',xlab="time",ylab="Chla",main="[Gwangsan Chla test data] response vs fitted_values (Time Varying Coefficient Model, (Gamma Distribution))",ylim=c(-100,500))
lines(data.tvcm1$time,data.tvcm1$response,type='o',col='blue')
legend(3650,500,c("fitted_values","response"),lwd=c(1,1),col=c("red","blue"))
```



### Time Varying Coefficient Model (quasi)

```{r}
vc <- gam(Chla~s(time)+s(time,by=BOD)+s(time,by=COD)+s(time,by=SS)+s(time,by=TN)+s(time,by=TP)+s(time,by=TOC)+s(time,by=log(TC))+s(time,by=Flow)+s(time,by=Rain),data=ex1,family=quasi(link="log"))
plot(vc,residuals=TRUE,pch=1,shade=TRUE,seWithMean=TRUE,shift=coef(vc)[1],ylim=c(-40,40))
ggGam(vc)
summary(vc) # Deviance explained = 71.3%    
par(mfrow=c(2,2))
gam.check(vc) 
par(mfrow=c(1,1))
```

#### Shrinkage variable selection with Generalized Cross-Validation Criterion or Mallow's Cp statistic

```{r}
vc.shrink <- gam(Chla~s(time)+s(time,by=BOD)+s(time,by=COD)+s(time,by=SS)+s(time,by=TN)+s(time,by=TP)+s(time,by=TOC)+s(time,by=log(TC))+s(time,by=Flow)+s(time,by=Rain),data=ex1,family=quasi(link="log"),method="GCV.Cp",select=TRUE)
plot(vc.shrink,residuals=TRUE,pch=1,shade=TRUE,seWithMean=TRUE,shift=coef(vc.shrink)[1],ylim=c(-40,40))
ggGam(vc.shrink) # 선택변수 : BOD, COD, SS, TN, TP, TOC, Flow, Rain  
summary(vc.shrink) # Deviance explained = 68.9%    
par(mfrow=c(2,2))
gam.check(vc.shrink) 
par(mfrow=c(1,1))
```

#### response vs fitted_values (train data (2010-2019))

```{r}
pred.tvcm <- predict(vc.shrink,newdata=ex1,type="response")
data.tvcm <- data.frame(response=ex1$Chla,fitted_values=pred.tvcm,time=ex1$time)
sqrt(sum((data.tvcm$response-data.tvcm$fitted_values)^2)/length(data.tvcm$response)) # RMSE = 18.67213     
ggplot(data.tvcm, aes(x=response, y=fitted_values)) +
  geom_point() + geom_rug() +
  ggtitle("[Gwangsan Chla train data] response vs fitted_values (Time Varying Coefficient Model, (Quasi Distribution))") +
  geom_abline(intercept=0,slope=1,color='blue',size=1.5)
par(mfrow=c(1,1))
plot(data.tvcm$time,data.tvcm$response,type='o',col='blue',xlab="time",ylab="Chla",main="[Gwangsan Chla train data] response vs fitted_values (Time Varying Coefficient Model, (Quasi Distribution))",ylim=c(-100,500))
lines(data.tvcm$time,data.tvcm$fitted_values,type='o',col='red')
legend(0,500,c("fitted_values","response"),lwd=c(1,1),col=c("red","blue"))
```

#### response vs fitted_values (test data (2020))

```{r}
ex1_1 <- read.csv("C:/Users/HSY/Desktop/광산(2020).csv",sep=",",header=T)
ex1_1 <- ex1_1[,-1]
ex1_1 <- as.data.frame(ex1_1)
pred.tvcm1 <- predict(vc.shrink,newdata=ex1_1,type="response")
data.tvcm1 <- data.frame(response=ex1_1$Chla,fitted_values=pred.tvcm1,time=ex1_1$time)
sqrt(sum((data.tvcm1$response-data.tvcm1$fitted_values)^2)/length(data.tvcm1$response)) # RMSE = 56.26718    
ggplot(data.tvcm1, aes(x=response, y=fitted_values)) +
  geom_point() + geom_rug() +
  ggtitle("[Gwangsan Chla test data] response vs fitted_values (Time Varying Coefficient Model, (Quasi Distribution))") +
  geom_abline(intercept=0,slope=1,color='blue',size=1.5)
par(mfrow=c(1,1))
plot(data.tvcm1$time,data.tvcm1$fitted_values,type='o',col='red',xlab="time",ylab="Chla",main="[Gwangsan Chla test data] response vs fitted_values (Time Varying Coefficient Model, (Quasi Distribution))",ylim=c(-100,500))
lines(data.tvcm1$time,data.tvcm1$response,type='o',col='blue')
legend(3650,500,c("fitted_values","response"),lwd=c(1,1),col=c("red","blue"))
```


#### 최종선택된 모형의 설명력(Deviance explained) : 56.3%(다중선형회귀모형), 53.9%(일반화선형모형(Gamma)), 63.3%(일반화가법모형(Gamma)), 66.2%(일반화가법모형(quasi)), 65.1%(시간에 따른 계수변화모형(Gamma)), 68.9%(시간에 따른 계수변화모형(quasi)) 

#### train data 관련 최종선택된 모형의 예측력(Root Mean Squared Error) : 22.13477(다중선형회귀모형), 31.8794(일반화선형모형(Gamma)), 22.63874(일반화가법모형(Gamma)), 19.45662(일반화가법모형(quasi)), 29.30506(일반화가법모형(Gamma)), 18.67213(시간에 따른 계수변화모형(quasi))

#### test data 관련 최종선택된 모형의 예측력(Root Mean Squared Error) : 46.53538(다중선형회귀모형), 52.70765(일반화선형모형(Gamma)), 46.79092(일반화가법모형(Gamma)), 45.85054(일반화가법모형(quasi)), 54.24671(시간에 따른 계수변화모형(Gamma)), 56.26718(시간에 따른 계수변화모형(quasi))

#### 일반화가법모형이나 시간에 따른 계수변화모형이 다중선형회귀모형보다 설명력이 우수하다는 것을 확실하게 보여주기 위해서는 설명변수들과 확실한 비선형관계가 있다고 여겨지는 변수를 반응변수로 선택하는 것이 좋다고 판단됨.

#### MLR의 경우 적절한 확률분포를 가정하고 있지 않고 있고 Chla의 예측값을 음수로 추정해주는 과오를 범하고 있기 때문에 최적의 모형이라고 할 수는 없다. 그리고 GLM, GAM, TVCM의 경우 예측값을 과대 또는 과소추정하는 경우가 있어서 RMSE의 기준으로 과소평가를 받을 수 있다.

#### 여러가지 사항을 고려했을 때 광산 Chla 예측에 대한 최적의 모형은 GAM(quasi)이라고 판단됨.






### 사용데이터 : 우치 지점 데이터

#### 모니터링 기간 : 2010~2019년 (일별 주단위자료) 

#### 반응변수 : Chla

#### 설명변수 : BOD, COD, SS, TN, TP, TOC, TC, Flow, Rain (과적합을 완화시키기 위해 사용할 설명변수를 일부 취사선택하였고, TC의 경우는 변동이 크기 때문에 로그를 취하여 적용함.) 

#### 상관분석이나 모형적합 시 각 수질항목의 원값을 그대로 사용하여 표현하는 것이 모형의 설명력이나 예측력 비교 등의 측면에서 더 적절할 수 있다고 판단하여 표준화를 하지 않았음.





### Spearman Correlation Analysis

```{r}
ex2 <- read.csv("C:/Users/HSY/Desktop/우치(2010-2019).csv", sep=",", header=T)
ex2 <- ex2[,-1]
X2 <- round(cor(ex2[,-18], method='spearman'),4) 
corrplot(X2)
p.mat2 <- cor_pmat(ex2[,-18], method='spearman')
ggcorrplot(X2, hc.order=T, type="lower", lab=T) +
  ggtitle("Correlation plot(Spearman) for water quality data (Uchi)") +   
  theme(plot.title = element_text(family = "serif", 
                                  face = "bold", hjust = 0.5, 
                                  size = 15, color = "black"))
ggcorrplot(X2, hc.order=T, type="lower", p.mat=p.mat2) +
  ggtitle("Correlation plot(Spearman) for water quality data with significance level (Uchi)") +   
  theme(plot.title = element_text(family = "serif", 
                                  face = "bold", hjust = 0.5, 
                                  size = 15, color = "black"))
ex22 <- ex2[,c(3,4,5,6,7,8,11,14,16,17)]
X_22 <- round(cor(ex22, method='spearman'),4) 
corrplot(X_22)
p.mat1 <- cor_pmat(ex22, method='spearman')
ggcorrplot(X_22, hc.order=T, type="lower", lab=T) +
  ggtitle("Correlation plot(Spearman) for water quality data (Uchi)") +   
  theme(plot.title = element_text(family = "serif", 
                                  face = "bold", hjust = 0.5, 
                                  size = 15, color = "black"))
ggcorrplot(X_22, hc.order=T, type="lower", p.mat=p.mat1) +
  ggtitle("Correlation plot(Spearman) for water quality data with significance level (Uchi)") +   
  theme(plot.title = element_text(family = "serif", 
                                  face = "bold", hjust = 0.5, 
                                  size = 15, color = "black"))
```



### SOM(Self-Organizing Map) pattern

```{r}
ex2 <- read.csv("C:/Users/HSY/Desktop/우치(2010-2019).csv", sep=",", header=T)
ex2 <- ex2[,-1]
ex2 <- as.data.frame(ex2)
ex2_matrix <- as.matrix(ex2)
som_grid <- somgrid(xdim=17, ydim=30, topo="hexagonal")
som_model <- som(ex2_matrix, grid=som_grid)
coolBlueHotRed <- function(n, alpha=1) {rainbow(n, end=4/6, alpha=alpha)[n:1]}
par(mfrow=c(1,2))
for (i in 1:17) {
  plot(som_model, type="property", property=getCodes(som_model)[,i], 
       main=colnames(getCodes(som_model))[i], palette.name=coolBlueHotRed)}
par(mfrow=c(1,1))
```




### Dependent(Response) variable : Chla

### Multiple Linear Regression

```{r}
ex2 <- read.csv("C:/Users/HSY/Desktop/우치(2010-2019).csv", sep=",", header=T)
ex2 <- ex2[,-1]
ex2 <- as.data.frame(ex2)
ggplot(data=ex2,aes(x=pH,y=Chla)) + geom_point() + stat_smooth(method=lm)
ggplot(data=ex2,aes(x=DO,y=Chla)) + geom_point() + stat_smooth(method=lm)
ggplot(data=ex2,aes(x=BOD,y=Chla)) + geom_point() + stat_smooth(method=lm)
ggplot(data=ex2,aes(x=COD,y=Chla)) + geom_point() + stat_smooth(method=lm)
ggplot(data=ex2,aes(x=SS,y=Chla)) + geom_point() + stat_smooth(method=lm)
ggplot(data=ex2,aes(x=TN,y=Chla)) + geom_point() + stat_smooth(method=lm)
ggplot(data=ex2,aes(x=TP,y=Chla)) + geom_point() + stat_smooth(method=lm)
ggplot(data=ex2,aes(x=TOC,y=Chla)) + geom_point() + stat_smooth(method=lm)
ggplot(data=ex2,aes(x=WT,y=Chla)) + geom_point() + stat_smooth(method=lm)
ggplot(data=ex2,aes(x=EC,y=Chla)) + geom_point() + stat_smooth(method=lm)
ggplot(data=ex2,aes(x=TC,y=Chla)) + geom_point() + stat_smooth(method=lm)
ggplot(data=ex2,aes(x=NH3N,y=Chla)) + geom_point() + stat_smooth(method=lm)
ggplot(data=ex2,aes(x=PO4P,y=Chla)) + geom_point() + stat_smooth(method=lm)
ggplot(data=ex2,aes(x=FC,y=Chla)) + geom_point() + stat_smooth(method=lm)
ggplot(data=ex2,aes(x=Flow,y=Chla)) + geom_point() + stat_smooth(method=lm)
ggplot(data=ex2,aes(x=Rain,y=Chla)) + geom_point() + stat_smooth(method=lm)
fit <- glm(Chla~BOD+COD+SS+TN+TP+TOC+log(TC)+Flow+Rain,data=ex2,family=gaussian(link="identity"))
summary(fit) # Deviance explained: 0.5398     
vif(fit) 
par(mfrow=c(2,2))
plot(fit)
par(mfrow=c(1,1))
dwtest(Chla~BOD+COD+SS+TN+TP+TOC+log(TC)+Flow+Rain,data=ex2) # 잔차가 양의 자기상관성을 가지고 있음.
# 다중회귀분석에 대한 기본가정인 잔차(residual)에 대한 정규성, 등분산성, 독립성, 선형성 등을 만족하지 못함.
```

#### Stepwise variable selection with AIC(Akaike’s Information Criterion)

```{r}
fit.step <- stepAIC(fit, direction="both", trace=TRUE)
fit.step # 선택변수 : BOD, TN, TP, log(TC), Flow 
summary(fit.step) # Deviance explained: 0.5392     
vif(fit.step)  
par(mfrow=c(2,2))
plot(fit.step)
par(mfrow=c(1,1))
dwtest(Chla~BOD+TN+TP+log(TC)+Flow,data=ex2) # 잔차가 양의 자기상관성을 가지고 있음.
# 다중회귀분석에 대한 기본가정인 잔차(residual)에 대한 정규성, 등분산성, 독립성, 선형성 등을 만족하지 못함.
```

#### response vs fitted_values (train data (2010-2019))

```{r}
pred.mlr <- predict(fit.step,newdata=ex2,type="response")
data.mlr <- data.frame(response=ex2$Chla,fitted_values=pred.mlr,
                       time=ex2$time)
sqrt(sum((data.mlr$response-data.mlr$fitted_values)^2)/
       length(data.mlr$response)) # RMSE = 15.97577 
ggplot(data.mlr, aes(x=response, y=fitted_values)) +
  geom_point() + geom_rug() +
  ggtitle("[Uchi Chla train data] response vs fitted_values 
          (Multiple Linear Regression)") +
  geom_abline(intercept=0,slope=1,color='blue',size=1.5)
par(mfrow=c(1,1))
plot(data.mlr$time,data.mlr$response,type='o',col='blue',
     xlab="time",ylab="Chla",main="[Uchi Chla train data] 
     response vs fitted_values (Multiple Linear Regression)",
     ylim=c(-100,500))
lines(data.mlr$time,data.mlr$fitted_values,type='o',col='red')
legend(0,500,c("fitted_values","response"),lwd=c(1,1),
       col=c("red","blue"))
```

#### response vs fitted_values (test data (2020))

```{r}
ex2_1 <- read.csv("C:/Users/HSY/Desktop/우치(2020).csv",
                  sep=",",header=T)
ex2_1 <- ex2_1[,-1]
ex2_1 <- as.data.frame(ex2_1)
pred.mlr1 <- predict(fit.step,newdata=ex2_1,type="response")
data.mlr1 <- data.frame(response=ex2_1$Chla,fitted_values=pred.mlr1,
                        time=ex2_1$time)
sqrt(sum((data.mlr1$response-data.mlr1$fitted_values)^2)/
       length(data.mlr1$response)) # RMSE = 14.45954    
ggplot(data.mlr1, aes(x=response, y=fitted_values)) +
  geom_point() + geom_rug() +
  ggtitle("[Uchi Chla test data] response vs fitted_values 
          (Multiple Linear Regression)") +
  geom_abline(intercept=0,slope=1,color='blue',size=1.5)
par(mfrow=c(1,1))
plot(data.mlr1$time,data.mlr1$response,type='o',col='blue',
     xlab="time",ylab="Chla",main="[Uchi Chla test data] 
     response vs fitted_values (Multiple Linear Regression)",
     ylim=c(-100,500))
lines(data.mlr1$time,data.mlr1$fitted_values,type='o',col='red')
legend(3650,500,c("fitted_values","response"),lwd=c(1,1),
       col=c("red","blue"))
```


### Generalized Linear Model (Gamma)

```{r}
m <- glm(Chla~BOD+COD+SS+TN+TP+TOC+log(TC)+Flow+Rain,data=ex2,family=Gamma(link="log"))
summary(m) # Deviance explained : 0.5896   
vif(m) 
par(mfrow=c(2,2))
plot(m)
par(mfrow=c(1,1))
```

#### Stepwise variable selection with AIC(Akaike’s Information Criterion)

```{r}
m.step <- stepAIC(m, direction="both", trace=TRUE)
m.step # 선택변수 : BOD, TN, TP, TOC, log(TC), Rain    
summary(m.step) # Deviance explained : 0.5877   
vif(m.step) 
par(mfrow=c(2,2))
plot(m.step)
par(mfrow=c(1,1))
```

#### response vs fitted_values (train data (2010-2019))

```{r}
pred.glm <- predict(m.step,newdata=ex2,type="response")
data.glm <- data.frame(response=ex2$Chla,fitted_values=pred.glm,
                       time=ex2$time)
sqrt(sum((data.glm$response-data.glm$fitted_values)^2)/
       length(data.glm$response)) # RMSE = 26.59489    
ggplot(data.glm, aes(x=response, y=fitted_values)) +
  geom_point() + geom_rug() +
  ggtitle("[Uchi Chla train data] response vs fitted_values 
          (Generalized Linear Model, (Gamma Distribution))") +
  geom_abline(intercept=0,slope=1,color='blue',size=1.5)
par(mfrow=c(1,1))
plot(data.glm$time,data.glm$response,type='o',col='blue',
     xlab="time",ylab="Chla",main="[Uchi Chla train data] 
     response vs fitted_values (Generalized Linear Model, (Gamma Distribution))",
     ylim=c(-100,500))
lines(data.glm$time,data.glm$fitted_values,type='o',col='red')
legend(0,500,c("fitted_values","response"),lwd=c(1,1),
       col=c("red","blue"))
```

#### response vs fitted_values (test data (2020))

```{r}
ex2_1 <- read.csv("C:/Users/HSY/Desktop/우치(2020).csv",
                  sep=",",header=T)
ex2_1 <- ex2_1[,-1]
ex2_1 <- as.data.frame(ex2_1)
pred.glm1 <- predict(m.step,newdata=ex2_1,type="response")
data.glm1 <- data.frame(response=ex2_1$Chla,fitted_values=pred.glm1,
                        time=ex2_1$time)
sqrt(sum((data.glm1$response-data.glm1$fitted_values)^2)/
       length(data.glm1$response)) # RMSE = 17.87154  
ggplot(data.glm1, aes(x=response, y=fitted_values)) +
  geom_point() + geom_rug() +
  ggtitle("[Uchi Chla test data] response vs fitted_values 
          (Generalized Linear Model, (Gamma Distribution))") +
  geom_abline(intercept=0,slope=1,color='blue',size=1.5)
par(mfrow=c(1,1))
plot(data.glm1$time,data.glm1$fitted_values,type='o',col='red',
     xlab="time",ylab="Chla",main="[Uchi Chla test data] 
     response vs fitted_values (Generalized Linear Model, (Gamma Distribution))",
     ylim=c(-100,500))
lines(data.glm1$time,data.glm1$response,type='o',col='blue')
legend(3650,500,c("fitted_values","response"),lwd=c(1,1),
       col=c("red","blue"))
```



### Generalized Additive Model (Gamma)

```{r}
# GAM의 경우 추정되는 계수(coefficients)가 데이터의 개수보다 많으면 적합되지 않음.
mm <- gam(Chla~s(BOD)+s(COD)+s(SS)+s(TN)+s(TP)+s(TOC)+s(log(TC))+s(Flow)+s(Rain),data=ex2,family=Gamma(link="log"))
plot(mm,residuals=TRUE,pch=1,shade=TRUE,seWithMean=TRUE,shift=coef(mm)[1])
ggGam(mm)
summary(mm) # Deviance explained = 72.3%  
concurvity(mm,full=TRUE) 
par(mfrow=c(2,2))
gam.check(mm) # 적합결여 존재 (기저함수 부족)
par(mfrow=c(1,1))
```

#### Shrinkage variable selection with Generalized Cross-Validation Criterion or Mallow's Cp statistic

```{r}
mm.shrink <- gam(Chla~s(BOD)+s(COD)+s(SS)+s(TN)+s(TP)+s(TOC)+s(log(TC))+s(Flow)+s(Rain),data=ex2,family=Gamma(link="log"),method="GCV.Cp",select=TRUE) 
plot(mm.shrink,residuals=TRUE,pch=1,shade=TRUE,seWithMean=TRUE,shift=coef(mm.shrink)[1])
ggGam(mm.shrink) # 선택변수 : BOD, COD, SS, TN, TP, TOC, Flow, Rain   
summary(mm.shrink) # Deviance explained = 71.4%    
concurvity(mm.shrink,full=TRUE) 
par(mfrow=c(2,2))
gam.check(mm.shrink) # 적합결여 존재 (기저함수 부족)
par(mfrow=c(1,1))
```

#### response vs fitted_values (train data (2010-2019))

```{r}
pred.gam <- predict(mm.shrink,newdata=ex2,type="response")
data.gam <- data.frame(response=ex2$Chla,fitted_values=pred.gam,
                       time=ex2$time)
sqrt(sum((data.gam$response-data.gam$fitted_values)^2)/
       length(data.gam$response)) # RMSE = 13.94729     
ggplot(data.gam, aes(x=response, y=fitted_values)) +
  geom_point() + geom_rug() +
  ggtitle("[Uchi Chla train data] response vs fitted_values 
          (Generalized Additive Model, (Gamma Distribution))") +
  geom_abline(intercept=0,slope=1,color='blue',size=1.5)
par(mfrow=c(1,1))
plot(data.gam$time,data.gam$response,type='o',col='blue',
     xlab="time",ylab="Chla",main="[Uchi Chla train data] 
     response vs fitted_values (Generalized Additive Model, (Gamma Distribution))",
     ylim=c(-100,500))
lines(data.gam$time,data.gam$fitted_values,type='o',col='red')
legend(0,500,c("fitted_values","response"),lwd=c(1,1),
       col=c("red","blue"))
```

#### response vs fitted_values (test data (2020))

```{r}
ex2_1 <- read.csv("C:/Users/HSY/Desktop/우치(2020).csv",
                  sep=",",header=T)
ex2_1 <- ex2_1[,-1]
ex2_1 <- as.data.frame(ex2_1)
pred.gam1 <- predict(mm.shrink,newdata=ex2_1,type="response")
data.gam1 <- data.frame(response=ex2_1$Chla,fitted_values=pred.gam1,
                        time=ex2_1$time)
sqrt(sum((data.gam1$response-data.gam1$fitted_values)^2)/
       length(data.gam1$response)) # RMSE = 16.91768   
ggplot(data.gam1, aes(x=response, y=fitted_values)) +
  geom_point() + geom_rug() +
  ggtitle("[Uchi Chla test data] response vs fitted_values 
          (Generalized Additive Model, (Gamma Distribution))") +
  geom_abline(intercept=0,slope=1,color='blue',size=1.5)
par(mfrow=c(1,1))
plot(data.gam1$time,data.gam1$fitted_values,type='o',col='red',
     xlab="time",ylab="Chla",main="[Uchi Chla test data] 
     response vs fitted_values (Generalized Additive Model, (Gamma Distribution))",
     ylim=c(-100,500))
lines(data.gam1$time,data.gam1$response,type='o',col='blue')
legend(3650,500,c("fitted_values","response"),lwd=c(1,1),
       col=c("red","blue"))
```




### Generalized Additive Model (quasi)

```{r}
# GAM의 경우 추정되는 계수(coefficients)가 데이터의 개수보다 많으면 적합되지 않음.
mm <- gam(Chla~s(BOD)+s(COD)+s(SS)+s(TN)+s(TP)+s(TOC)+s(log(TC))+s(Flow)+s(Rain),data=ex2,family=quasi(link="log"))
plot(mm,residuals=TRUE,pch=1,shade=TRUE,seWithMean=TRUE,shift=coef(mm)[1])
ggGam(mm)
summary(mm) # Deviance explained = 75.3%   
concurvity(mm,full=TRUE) 
par(mfrow=c(2,2))
gam.check(mm) # 적합결여 존재 (기저함수 부족)
par(mfrow=c(1,1))
```

#### Shrinkage variable selection with Generalized Cross-Validation Criterion or Mallow's Cp statistic

```{r}
mm.shrink <- gam(Chla~s(BOD)+s(COD)+s(SS)+s(TN)+s(TP)+s(TOC)+s(log(TC))+s(Flow)+s(Rain),data=ex2,family=quasi(link="log"),method="GCV.Cp",select=TRUE) 
plot(mm.shrink,residuals=TRUE,pch=1,shade=TRUE,seWithMean=TRUE,shift=coef(mm.shrink)[1])
ggGam(mm.shrink) # 선택변수 : BOD, COD, SS, TN, TP, TOC, log(TC), Flow, Rain  
summary(mm.shrink) # Deviance explained = 74%    
concurvity(mm.shrink,full=TRUE) 
par(mfrow=c(2,2))
gam.check(mm.shrink) # 적합결여 존재 (기저함수 부족)
par(mfrow=c(1,1))
```

#### response vs fitted_values (train data (2010-2019))

```{r}
pred.gam <- predict(mm.shrink,newdata=ex2,type="response")
data.gam <- data.frame(response=ex2$Chla,fitted_values=pred.gam,
                       time=ex2$time)
sqrt(sum((data.gam$response-data.gam$fitted_values)^2)/
       length(data.gam$response)) # RMSE = 11.99769     
ggplot(data.gam, aes(x=response, y=fitted_values)) +
  geom_point() + geom_rug() +
  ggtitle("[Uchi Chla train data] response vs fitted_values 
          (Generalized Additive Model, (Quasi Distribution))") +
  geom_abline(intercept=0,slope=1,color='blue',size=1.5)
par(mfrow=c(1,1))
plot(data.gam$time,data.gam$response,type='o',col='blue',
     xlab="time",ylab="Chla",main="[Uchi Chla train data] 
     response vs fitted_values (Generalized Additive Model, (Quasi Distribution))",
     ylim=c(-100,500))
lines(data.gam$time,data.gam$fitted_values,type='o',col='red')
legend(0,500,c("fitted_values","response"),lwd=c(1,1),
       col=c("red","blue"))
```

#### response vs fitted_values (test data (2020))

```{r}
ex2_1 <- read.csv("C:/Users/HSY/Desktop/우치(2020).csv",
                  sep=",",header=T)
ex2_1 <- ex2_1[,-1]
ex2_1 <- as.data.frame(ex2_1)
pred.gam1 <- predict(mm.shrink,newdata=ex2_1,type="response")
data.gam1 <- data.frame(response=ex2_1$Chla,fitted_values=pred.gam1,
                        time=ex2_1$time)
sqrt(sum((data.gam1$response-data.gam1$fitted_values)^2)/
       length(data.gam1$response)) # RMSE = 22.4226  
ggplot(data.gam1, aes(x=response, y=fitted_values)) +
  geom_point() + geom_rug() +
  ggtitle("[Uchi Chla test data] response vs fitted_values 
          (Generalized Additive Model, (Quasi Distribution))") +
  geom_abline(intercept=0,slope=1,color='blue',size=1.5)
par(mfrow=c(1,1))
plot(data.gam1$time,data.gam1$fitted_values,type='o',col='red',
     xlab="time",ylab="Chla",main="[Uchi Chla test data] 
     response vs fitted_values (Generalized Additive Model, (Quasi Distribution))",
     ylim=c(-100,500))
lines(data.gam1$time,data.gam1$response,type='o',col='blue')
legend(3650,500,c("fitted_values","response"),lwd=c(1,1),
       col=c("red","blue"))
```



### Time Varying Coefficient Model (Gamma)

```{r}
vc <- gam(Chla~s(time)+s(time,by=BOD)+s(time,by=COD)+s(time,by=SS)+s(time,by=TN)+s(time,by=TP)+s(time,by=TOC)+s(time,by=log(TC))+s(time,by=Flow)+s(time,by=Rain),data=ex2,family=Gamma(link="log"))
plot(vc,residuals=TRUE,pch=1,shade=TRUE,seWithMean=TRUE,shift=coef(vc)[1],ylim=c(-40,40))
ggGam(vc)
summary(vc) # Deviance explained = 70%     
par(mfrow=c(2,2))
gam.check(vc) 
par(mfrow=c(1,1))
```

#### Shrinkage variable selection with Generalized Cross-Validation Criterion or Mallow's Cp statistic

```{r}
vc.shrink <- gam(Chla~s(time)+s(time,by=BOD)+s(time,by=COD)+s(time,by=SS)+s(time,by=TN)+s(time,by=TP)+s(time,by=TOC)+s(time,by=log(TC))+s(time,by=Flow)+s(time,by=Rain),data=ex2,family=Gamma(link="log"),method="GCV.Cp",select=TRUE)
plot(vc.shrink,residuals=TRUE,pch=1,shade=TRUE,seWithMean=TRUE,shift=coef(vc.shrink)[1],ylim=c(-40,40))
ggGam(vc.shrink) # 선택변수 : BOD, COD, SS, TN, TP, log(TC), Flow, Rain 
summary(vc.shrink) # Deviance explained = 69.9%     
par(mfrow=c(2,2))
gam.check(vc.shrink) 
par(mfrow=c(1,1))
```

#### response vs fitted_values (train data (2010-2019))

```{r}
pred.tvcm <- predict(vc.shrink,newdata=ex2,type="response")
data.tvcm <- data.frame(response=ex2$Chla,fitted_values=pred.tvcm,
                        time=ex2$time)
sqrt(sum((data.tvcm$response-data.tvcm$fitted_values)^2)/
       length(data.tvcm$response)) # RMSE = 22.04343     
ggplot(data.tvcm, aes(x=response, y=fitted_values)) +
  geom_point() + geom_rug() +
  ggtitle("[Uchi Chla train data] response vs fitted_values 
          (Time Varying Coefficient Model, (Gamma Distribution))") +
  geom_abline(intercept=0,slope=1,color='blue',size=1.5)
par(mfrow=c(1,1))
plot(data.tvcm$time,data.tvcm$response,type='o',col='blue',
     xlab="time",ylab="Chla",main="[Uchi Chla train data] 
     response vs fitted_values (Time Varying Coefficient Model, (Gamma Distribution))",
     ylim=c(-100,500))
lines(data.tvcm$time,data.tvcm$fitted_values,type='o',col='red')
legend(0,500,c("fitted_values","response"),lwd=c(1,1),
       col=c("red","blue"))
```

#### response vs fitted_values (test data (2020))

```{r}
ex2_1 <- read.csv("C:/Users/HSY/Desktop/우치(2020).csv",
                  sep=",",header=T)
ex2_1 <- ex2_1[,-1]
ex2_1 <- as.data.frame(ex2_1)
pred.tvcm1 <- predict(vc.shrink,newdata=ex2_1,type="response")
data.tvcm1 <- data.frame(response=ex2_1$Chla,fitted_values=pred.tvcm1,
                         time=ex2_1$time)
sqrt(sum((data.tvcm1$response-data.tvcm1$fitted_values)^2)/
       length(data.tvcm1$response)) # RMSE = 33.93084   
ggplot(data.tvcm1, aes(x=response, y=fitted_values)) +
  geom_point() + geom_rug() +
  ggtitle("[Uchi Chla test data] response vs fitted_values 
          (Time Varying Coefficient Model, (Gamma Distribution))") +
  geom_abline(intercept=0,slope=1,color='blue',size=1.5)
par(mfrow=c(1,1))
plot(data.tvcm1$time,data.tvcm1$fitted_values,type='o',col='red',
     xlab="time",ylab="Chla",main="[Uchi Chla test data] 
     response vs fitted_values (Time Varying Coefficient Model, (Gamma Distribution))",
     ylim=c(-100,500))
lines(data.tvcm1$time,data.tvcm1$response,type='o',col='blue')
legend(3650,500,c("fitted_values","response"),lwd=c(1,1),
       col=c("red","blue"))
```



### Time Varying Coefficient Model (quasi)

```{r}
vc <- gam(Chla~s(time)+s(time,by=BOD)+s(time,by=COD)+s(time,by=SS)+s(time,by=TN)+s(time,by=TP)+s(time,by=TOC)+s(time,by=log(TC))+s(time,by=Flow)+s(time,by=Rain),data=ex2,family=quasi(link="log"))
plot(vc,residuals=TRUE,pch=1,shade=TRUE,seWithMean=TRUE,shift=coef(vc)[1],ylim=c(-40,40))
ggGam(vc)
summary(vc) # Deviance explained = 81.7%     
par(mfrow=c(2,2))
gam.check(vc) 
par(mfrow=c(1,1))
```

#### Shrinkage variable selection with Generalized Cross-Validation Criterion or Mallow's Cp statistic

```{r}
vc.shrink <- gam(Chla~s(time)+s(time,by=BOD)+s(time,by=COD)+s(time,by=SS)+s(time,by=TN)+s(time,by=TP)+s(time,by=TOC)+s(time,by=log(TC))+s(time,by=Flow)+s(time,by=Rain),data=ex2,family=quasi(link="log"),method="GCV.Cp",select=TRUE)
plot(vc.shrink,residuals=TRUE,pch=1,shade=TRUE,seWithMean=TRUE,shift=coef(vc.shrink)[1],ylim=c(-40,40))
ggGam(vc.shrink) # 선택변수 : BOD, COD, SS, TN, TP, TOC, log(TC), Flow, Rain  
summary(vc.shrink) # Deviance explained = 81%     
par(mfrow=c(2,2))
gam.check(vc.shrink) 
par(mfrow=c(1,1))
```

#### response vs fitted_values (train data (2010-2019))

```{r}
pred.tvcm <- predict(vc.shrink,newdata=ex2,type="response")
data.tvcm <- data.frame(response=ex2$Chla,fitted_values=pred.tvcm,
                        time=ex2$time)
sqrt(sum((data.tvcm$response-data.tvcm$fitted_values)^2)/
       length(data.tvcm$response)) # RMSE = 10.26264     
ggplot(data.tvcm, aes(x=response, y=fitted_values)) +
  geom_point() + geom_rug() +
  ggtitle("[Uchi Chla train data] response vs fitted_values 
          (Time Varying Coefficient Model, (Quasi Distribution))") +
  geom_abline(intercept=0,slope=1,color='blue',size=1.5)
par(mfrow=c(1,1))
plot(data.tvcm$time,data.tvcm$response,type='o',col='blue',
     xlab="time",ylab="Chla",main="[Uchi Chla train data] 
     response vs fitted_values (Time Varying Coefficient Model, (Quasi Distribution))",
     ylim=c(-100,500))
lines(data.tvcm$time,data.tvcm$fitted_values,type='o',col='red')
legend(0,500,c("fitted_values","response"),lwd=c(1,1),
       col=c("red","blue"))
```

#### response vs fitted_values (test data (2020))

```{r}
ex2_1 <- read.csv("C:/Users/HSY/Desktop/우치(2020).csv",
                  sep=",",header=T)
ex2_1 <- ex2_1[,-1]
ex2_1 <- as.data.frame(ex2_1)
pred.tvcm1 <- predict(vc.shrink,newdata=ex2_1,type="response")
data.tvcm1 <- data.frame(response=ex2_1$Chla,fitted_values=pred.tvcm1,
                         time=ex2_1$time)
sqrt(sum((data.tvcm1$response-data.tvcm1$fitted_values)^2)/
       length(data.tvcm1$response)) # RMSE = 36.84388  
ggplot(data.tvcm1, aes(x=response, y=fitted_values)) +
  geom_point() + geom_rug() +
  ggtitle("[Uchi Chla test data] response vs fitted_values 
          (Time Varying Coefficient Model, (Quasi Distribution))") +
  geom_abline(intercept=0,slope=1,color='blue',size=1.5)
par(mfrow=c(1,1))
plot(data.tvcm1$time,data.tvcm1$fitted_values,type='o',col='red',
     xlab="time",ylab="Chla",main="[Uchi Chla test data] 
     response vs fitted_values (Time Varying Coefficient Model, (Quasi Distribution))",
     ylim=c(-100,500))
lines(data.tvcm1$time,data.tvcm1$response,type='o',col='blue')
legend(3650,500,c("fitted_values","response"),lwd=c(1,1),
       col=c("red","blue"))
```


#### 최종선택된 모형의 설명력(Deviance explained) : 53.9%(다중선형회귀모형), 58.8%(일반화선형모형(Gamma)), 71.4%(일반화가법모형(Gamma)), 74.0%(일반화가법모형(quasi)), 69.9%(시간에 따른 계수변화모형(Gamma)), 81.0%(시간에 따른 계수변화모형(quasi))

#### train data 관련 최종선택된 모형의 예측력(Root Mean Squared Error) : 15.97577(다중선형회귀모형), 26.59489(일반화선형모형(Gamma)), 13.94729(일반화가법모형(Gamma)), 11.99769(일반화가법모형(quasi)), 22.04343(시간에 따른 계수변화모형(Gamma)), 10.26264(시간에 따른 계수변화모형(quasi))

#### test data 관련 최종선택된 모형의 예측력(Root Mean Squared Error) : 14.45954(다중선형회귀모형), 17.87154(일반화선형모형(Gamma)), 16.91768(일반화가법모형(Gamma)), 22.4226(일반화가법모형(quasi)), 33.93084(시간에 따른 계수변화모형(Gamma)), 36.84388(시간에 따른 계수변화모형(quasi))

#### 일반화가법모형이나 시간에 따른 계수변화모형이 다중선형회귀모형보다 설명력이 우수하다는 것을 확실하게 보여주기 위해서는 설명변수들과 확실한 비선형관계가 있다고 여겨지는 변수를 반응변수로 선택하는 것이 좋다고 판단됨.

#### test RMSE의 경우 MLR이 가장 작게 나왔다. 하지만, MLR의 경우 적절한 확률분포를 가정하고 있지 않고 있고 Chla의 예측값을 음수로 추정해주는 과오를 범하고 있기 때문에 최적의 모형이라고 할 수는 없다. 그리고 GLM, GAM, TVCM의 경우 예측값을 과대 또는 과소추정하는 경우가 있어서 RMSE의 기준으로 과소평가를 받을 수 있다.

#### 여러가지 사항을 고려했을 때 우치 Chla 예측에 대한 최적의 모형은 GAM(Gamma)이라고 판단됨.