---
title: "Functional Regression"
author: "Hwang Seong-Yun"
date: '2020 11 7 '
output: html_document
---

### 필요 패키지 

```{r}
library(tidyverse)
library(mgcv)
library(ggplot2)
library(gridExtra)
library(moonBook)
library(ztable)
library(survival)
library(ggGam)
library(corrplot)
library(ggcorrplot)
library(car)
library(lmtest)
library(fda)
library(refund)
```

#### 사용데이터 : 광산 지점 데이터
#### 모니터링 기간 : 2010~2019년 (일별 주단위자료) 
#### 반응변수 : Chl_a
#### 설명변수 : pH, DO, BOD, COD, SS, T_N, T_P, TOC, WT, EC, TC, NH3_N, PO4_P, FC, Flow, Rain


### Functional Regression
#### Functional Data Analysis : 각각의 변수들이 시간에 대한 함수(function)임에 초점을 맞추어 분석하는 것

#### scaling data 사용

#### Smoothing by Fourier basis : 주기적인 데이터에 유용함

#### 기저의 개수가 많을수록 함수적 자료의 형태가 이산형 자료가 되어 편의(bias)가 줄어들고, 기저의 개수가 적을수록 평활화 정도가 커지게 되어 분산이 줄어든다. 본 데이터는 주단위자료이고 주기가 약 51이므로 기저함수의 개수를 중간정도인 25로 정함.

```{r}
daybasisfourier <- create.fourier.basis(c(0, 510), nbasis=25, period=51) 
pH.fb <- smooth.basis(argvals=1:510, ex1$pH, daybasisfourier, fdnames=list("week", "Station", "pH"))$fd
par(mfrow=c(2,1))
plot(pH.fb) ; plot(ex1$pH)
par(mfrow=c(1,1))
DO.fb <- smooth.basis(argvals=1:510, ex1$DO, daybasisfourier, fdnames=list("week", "Station", "DO"))$fd
par(mfrow=c(2,1))
plot(DO.fb) ; plot(ex1$DO)
par(mfrow=c(1,1))
BOD.fb <- smooth.basis(argvals=1:510, ex1$BOD, daybasisfourier, fdnames=list("week", "Station", "BOD"))$fd
par(mfrow=c(2,1))
plot(BOD.fb) ; plot(ex1$BOD)
par(mfrow=c(1,1))
COD.fb <- smooth.basis(argvals=1:510, ex1$COD, daybasisfourier, fdnames=list("week", "Station", "COD"))$fd
par(mfrow=c(2,1))
plot(COD.fb) ; plot(ex1$COD)
par(mfrow=c(1,1))
SS.fb <- smooth.basis(argvals=1:510, ex1$SS, daybasisfourier, fdnames=list("week", "Station", "SS"))$fd
par(mfrow=c(2,1))
plot(SS.fb) ; plot(ex1$SS)
par(mfrow=c(1,1))
T_N.fb <- smooth.basis(argvals=1:510, ex1$T_N, daybasisfourier, fdnames=list("week", "Station", "T_N"))$fd
par(mfrow=c(2,1))
plot(T_N.fb) ; plot(ex1$T_N)
par(mfrow=c(1,1))
T_P.fb <- smooth.basis(argvals=1:510, ex1$T_P, daybasisfourier, fdnames=list("week", "Station", "T_P"))$fd
par(mfrow=c(2,1))
plot(T_P.fb) ; plot(ex1$T_P)
par(mfrow=c(1,1))
TOC.fb <- smooth.basis(argvals=1:510, ex1$TOC, daybasisfourier, fdnames=list("week", "Station", "TOC"))$fd
par(mfrow=c(2,1))
plot(TOC.fb) ; plot(ex1$TOC)
par(mfrow=c(1,1))
WT.fb <- smooth.basis(argvals=1:510, ex1$WT, daybasisfourier, fdnames=list("week", "Station", "WT"))$fd
par(mfrow=c(2,1))
plot(WT.fb) ; plot(ex1$WT)
par(mfrow=c(1,1))
EC.fb <- smooth.basis(argvals=1:510, ex1$EC, daybasisfourier, fdnames=list("week", "Station", "EC"))$fd
par(mfrow=c(2,1))
plot(EC.fb) ; plot(ex1$EC)
par(mfrow=c(1,1))
TC.fb <- smooth.basis(argvals=1:510, ex1$TC, daybasisfourier, fdnames=list("week", "Station", "TC"))$fd
par(mfrow=c(2,1))
plot(TC.fb) ; plot(ex1$TC)
par(mfrow=c(1,1))
NH3_N.fb <- smooth.basis(argvals=1:510, ex1$NH3_N, daybasisfourier, fdnames=list("week", "Station", "NH3_N"))$fd
par(mfrow=c(2,1))
plot(NH3_N.fb) ; plot(ex1$NH3_N)
par(mfrow=c(1,1))
PO4_P.fb <- smooth.basis(argvals=1:510, ex1$PO4_P, daybasisfourier, fdnames=list("week", "Station", "PO4_P"))$fd
par(mfrow=c(2,1))
plot(PO4_P.fb) ; plot(ex1$PO4_P)
par(mfrow=c(1,1))
Chl_a.fb <- smooth.basis(argvals=1:510, ex1$Chl_a, daybasisfourier, fdnames=list("week", "Station", "Chl_a"))$fd
par(mfrow=c(2,1))
plot(Chl_a.fb) ; plot(ex1$Chl_a)
par(mfrow=c(1,1))
FC.fb <- smooth.basis(argvals=1:510, ex1$FC, daybasisfourier, fdnames=list("week", "Station", "FC"))$fd
par(mfrow=c(2,1))
plot(FC.fb) ; plot(ex1$FC)
par(mfrow=c(1,1))
Flow.fb <- smooth.basis(argvals=1:510, ex1$Flow, daybasisfourier, fdnames=list("week", "Station", "Flow"))$fd
par(mfrow=c(2,1))
plot(Flow.fb) ; plot(ex1$Flow)
par(mfrow=c(1,1))
Rain.fb <- smooth.basis(argvals=1:510, ex1$Rain, daybasisfourier, fdnames=list("week", "Station", "Rain"))$fd
par(mfrow=c(2,1))
plot(Rain.fb) ; plot(ex1$Rain)
par(mfrow=c(1,1))
```

#### Smoothing by B-spline basis : 비주기적인 데이터에 유용함

#### 본 데이터는 10년간 측정한 일별 주단위데이터이므로 각 년도마다 4분기로 나누어서 평활화하는 것이 바람직하다고 판단하여 부분구간의 개수를 40으로 정하고 cubic spline을 사용하였음. 이에 따라 기저함수의 개수는 3+40-1=42로 정함. 

```{r}
daybasisspline <- create.bspline.basis(c(0, 510), nbasis=42, norder=4)
pH.Bb <- smooth.basis(argvals=1:510, ex1$pH, daybasisspline, fdnames=list("week", "Station", "pH"))$fd
par(mfrow=c(2,1))
plot(pH.Bb) ; plot(ex1$pH) 
par(mfrow=c(1,1))
DO.Bb <- smooth.basis(argvals=1:510, ex1$DO, daybasisspline, fdnames=list("week", "Station", "DO"))$fd
par(mfrow=c(2,1))
plot(DO.Bb) ; plot(ex1$DO) 
par(mfrow=c(1,1))
BOD.Bb <- smooth.basis(argvals=1:510, ex1$BOD, daybasisspline, fdnames=list("week", "Station", "BOD"))$fd
par(mfrow=c(2,1))
plot(BOD.Bb) ; plot(ex1$BOD) 
par(mfrow=c(1,1))
COD.Bb <- smooth.basis(argvals=1:510, ex1$COD, daybasisspline, fdnames=list("week", "Station", "COD"))$fd
par(mfrow=c(2,1))
plot(COD.Bb) ; plot(ex1$COD) 
par(mfrow=c(1,1))
SS.Bb <- smooth.basis(argvals=1:510, ex1$SS, daybasisspline, fdnames=list("week", "Station", "SS"))$fd
par(mfrow=c(2,1))
plot(SS.Bb) ; plot(ex1$SS) 
par(mfrow=c(1,1))
T_N.Bb <- smooth.basis(argvals=1:510, ex1$T_N, daybasisspline, fdnames=list("week", "Station", "T_N"))$fd
par(mfrow=c(2,1))
plot(T_N.Bb) ; plot(ex1$T_N) 
par(mfrow=c(1,1))
T_P.Bb <- smooth.basis(argvals=1:510, ex1$T_P, daybasisspline, fdnames=list("week", "Station", "T_P"))$fd
par(mfrow=c(2,1))
plot(T_P.Bb) ; plot(ex1$T_P) 
par(mfrow=c(1,1))
TOC.Bb <- smooth.basis(argvals=1:510, ex1$TOC, daybasisspline, fdnames=list("week", "Station", "TOC"))$fd
par(mfrow=c(2,1))
plot(TOC.Bb) ; plot(ex1$TOC) 
par(mfrow=c(1,1))
WT.Bb <- smooth.basis(argvals=1:510, ex1$WT, daybasisspline, fdnames=list("week", "Station", "WT"))$fd
par(mfrow=c(2,1))
plot(WT.Bb) ; plot(ex1$WT) 
par(mfrow=c(1,1))
EC.Bb <- smooth.basis(argvals=1:510, ex1$EC, daybasisspline, fdnames=list("week", "Station", "EC"))$fd
par(mfrow=c(2,1))
plot(EC.Bb) ; plot(ex1$EC) 
par(mfrow=c(1,1))
TC.Bb <- smooth.basis(argvals=1:510, ex1$TC, daybasisspline, fdnames=list("week", "Station", "TC"))$fd
par(mfrow=c(2,1))
plot(TC.Bb) ; plot(ex1$TC) 
par(mfrow=c(1,1))
NH3_N.Bb <- smooth.basis(argvals=1:510, ex1$NH3_N, daybasisspline, fdnames=list("week", "Station", "NH3_N"))$fd
par(mfrow=c(2,1))
plot(NH3_N.Bb) ; plot(ex1$NH3_N) 
par(mfrow=c(1,1))
PO4_P.Bb <- smooth.basis(argvals=1:510, ex1$PO4_P, daybasisspline, fdnames=list("week", "Station", "PO4_P"))$fd
par(mfrow=c(2,1))
plot(PO4_P.Bb) ; plot(ex1$PO4_P) 
par(mfrow=c(1,1))
Chl_a.Bb <- smooth.basis(argvals=1:510, ex1$Chl_a, daybasisspline, fdnames=list("week", "Station", "Chl_a"))$fd
par(mfrow=c(2,1))
plot(Chl_a.Bb) ; plot(ex1$Chl_a) 
par(mfrow=c(1,1))
Chl_a.Bb <- smooth.basis(argvals=1:510, ex1$Chl_a, daybasisspline, fdnames=list("week", "Station", "Chl_a"))$fd
par(mfrow=c(2,1))
plot(Chl_a.Bb) ; plot(ex1$Chl_a) 
par(mfrow=c(1,1))
FC.Bb <- smooth.basis(argvals=1:510, ex1$FC, daybasisspline, fdnames=list("week", "Station", "FC"))$fd
par(mfrow=c(2,1))
plot(FC.Bb) ; plot(ex1$FC) 
par(mfrow=c(1,1))
Flow.Bb <- smooth.basis(argvals=1:510, ex1$Flow, daybasisspline, fdnames=list("week", "Station", "Flow"))$fd
par(mfrow=c(2,1))
plot(Flow.Bb) ; plot(ex1$Flow) 
par(mfrow=c(1,1))
Rain.Bb <- smooth.basis(argvals=1:510, ex1$Rain, daybasisspline, fdnames=list("week", "Station", "Rain"))$fd
par(mfrow=c(2,1))
plot(Rain.Bb) ; plot(ex1$Rain) 
par(mfrow=c(1,1))
```

#### 재표현 결과, Fourier basis보다는 B-spline basis 방법이 각 변수의 특성을 더 잘 설명하는 함수를 추정해주는 것으로 보여진다. 이는 비주기적인 특성이나 이상점(outlier) 등의 영향 때문인것으로 파악된다. 따라서 B-spline basis 방법으로 재표현된 결과를 가지고 함수적 회귀모형을 적합해보도록 한다. 

#### 

```{r}
daybasisspline <- create.bspline.basis(c(0, 510), nbasis=42, norder=4)
pH.Bb <- smooth.basis(argvals=1:510, ex1$pH, daybasisspline)$fd
DO.Bb <- smooth.basis(argvals=1:510, ex1$DO, daybasisspline)$fd
BOD.Bb <- smooth.basis(argvals=1:510, ex1$BOD, daybasisspline)$fd
COD.Bb <- smooth.basis(argvals=1:510, ex1$COD, daybasisspline)$fd
SS.Bb <- smooth.basis(argvals=1:510, ex1$SS, daybasisspline)$fd
T_N.Bb <- smooth.basis(argvals=1:510, ex1$T_N, daybasisspline)$fd
T_P.Bb <- smooth.basis(argvals=1:510, ex1$T_P, daybasisspline)$fd
TOC.Bb <- smooth.basis(argvals=1:510, ex1$TOC, daybasisspline)$fd
WT.Bb <- smooth.basis(argvals=1:510, ex1$WT, daybasisspline)$fd
EC.Bb <- smooth.basis(argvals=1:510, ex1$EC, daybasisspline)$fd
TC.Bb <- smooth.basis(argvals=1:510, ex1$TC, daybasisspline)$fd
NH3_N.Bb <- smooth.basis(argvals=1:510, ex1$NH3_N, daybasisspline)$fd
PO4_P.Bb <- smooth.basis(argvals=1:510, ex1$PO4_P, daybasisspline)$fd
Chl_a.Bb <- smooth.basis(argvals=1:510, ex1$Chl_a, daybasisspline)$fd
Chl_a.Bb <- smooth.basis(argvals=1:510, ex1$Chl_a, daybasisspline)$fd
FC.Bb <- smooth.basis(argvals=1:510, ex1$FC, daybasisspline)$fd
Flow.Bb <- smooth.basis(argvals=1:510, ex1$Flow, daybasisspline)$fd
Rain.Bb <- smooth.basis(argvals=1:510, ex1$Rain, daybasisspline)$fd
Chl_a.fR <- fRegress(Chl_a.Bb ~ pH.Bb+DO.Bb+BOD.Bb+COD.Bb+SS.Bb+T_N.Bb+T_P.Bb+TOC.Bb+WT.Bb+EC.Bb+TC.Bb+NH3_N.Bb+PO4_P.Bb+FC.Bb+Flow.Bb+Rain.Bb)
```

