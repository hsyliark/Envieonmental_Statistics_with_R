---
title: "Generalized Additive Model, Functional Regression"
author: "Hwang Seong-Yun"
date: '2020 11 7 '
output: html_document
---

### 필요 패키지 

```{r}
library(tidyverse)
library(mgcv)
library(ggplot2)
library(gridExtra)
library(moonBook)
library(ztable)
library(survival)
library(ggGam)
library(corrplot)
library(ggcorrplot)
library(car)
library(lmtest)
library(fda)
library(refund)
```

#### 사용데이터 : 광산 지점 데이터
#### 모니터링 기간 : 2010~2019년 (일별 주단위자료) 
#### 반응변수 : Chl_a
#### 설명변수 : pH, DO, BOD, COD, SS, T_N, T_P, TOC, WT, EC, TC, NH3_N, PO4_P, FC, Flow, Rain


### Multiple Linear Regression
#### scaling data 사용

```{r}
ex1 <- read.csv("C:/Users/HSY/Desktop/광산일별데이터(2010-2019).csv", sep=",", header=T)
ex1 <- ex1[,-1]
ex1_scale <- scale(ex1)
ex1_scale <- as.data.frame(ex1_scale)
p1 <- ggplot(data=ex1_scale,aes(x=pH,y=Chl_a)) + geom_point() + stat_smooth(method=lm)
p2 <- ggplot(data=ex1_scale,aes(x=DO,y=Chl_a)) + geom_point() + stat_smooth(method=lm)
p3 <- ggplot(data=ex1_scale,aes(x=BOD,y=Chl_a)) + geom_point() + stat_smooth(method=lm)
p4 <- ggplot(data=ex1_scale,aes(x=COD,y=Chl_a)) + geom_point() + stat_smooth(method=lm)
p5 <- ggplot(data=ex1_scale,aes(x=SS,y=Chl_a)) + geom_point() + stat_smooth(method=lm)
p6 <- ggplot(data=ex1_scale,aes(x=T_N,y=Chl_a)) + geom_point() + stat_smooth(method=lm)
p7 <- ggplot(data=ex1_scale,aes(x=T_P,y=Chl_a)) + geom_point() + stat_smooth(method=lm)
p8 <- ggplot(data=ex1_scale,aes(x=TOC,y=Chl_a)) + geom_point() + stat_smooth(method=lm)
p9 <- ggplot(data=ex1_scale,aes(x=WT,y=Chl_a)) + geom_point() + stat_smooth(method=lm)
p10 <- ggplot(data=ex1_scale,aes(x=EC,y=Chl_a)) + geom_point() + stat_smooth(method=lm)
p11 <- ggplot(data=ex1_scale,aes(x=TC,y=Chl_a)) + geom_point() + stat_smooth(method=lm)
p12 <- ggplot(data=ex1_scale,aes(x=NH3_N,y=Chl_a)) + geom_point() + stat_smooth(method=lm)
p13 <- ggplot(data=ex1_scale,aes(x=PO4_P,y=Chl_a)) + geom_point() + stat_smooth(method=lm)
p14 <- ggplot(data=ex1_scale,aes(x=FC,y=Chl_a)) + geom_point() + stat_smooth(method=lm)
p15 <- ggplot(data=ex1_scale,aes(x=Flow,y=Chl_a)) + geom_point() + stat_smooth(method=lm)
p16 <- ggplot(data=ex1_scale,aes(x=Rain,y=Chl_a)) + geom_point() + stat_smooth(method=lm)
grid.arrange(p1,p2,p3,p4,p5,p6,p7,p8,p9,p10,p11,p12,p13,p14,p15,p16,nrow=4,ncol=4)
fit <- lm(Chl_a~.,data=ex1_scale)
summary(fit)
vif(fit) # 다중공선성(multicollinearity) 존재
par(mfrow=c(2,2))
plot(fit)
par(mfrow=c(1,1))
n <- length(residuals(fit))
plot(tail(residuals(fit),n-1) ~ head(residuals(fit),n-1), xlab= expression(hat(epsilon)[i]),ylab=expression(hat(epsilon)[i+1]))
abline(h=0,v=0,col=grey(0.75))
dwtest(Chl_a~.,data=ex1_scale) # 잔차가 양의 자기상관성을 가지고 있음.
fit1 <- lm(Chl_a~DO+BOD+COD+SS+T_P+WT+TC+PO4_P,data=ex1_scale) # 모형 fit에서 유의하지 않은 변수를 제외함.
summary(fit1) # Adjusted R-squared:  0.6405  
vif(fit1)
par(mfrow=c(2,2))
plot(fit1)
par(mfrow=c(1,1))
n <- length(residuals(fit1))
plot(tail(residuals(fit1),n-1) ~ head(residuals(fit1),n-1), xlab= expression(hat(epsilon)[i]),ylab=expression(hat(epsilon)[i+1]))
abline(h=0,v=0,col=grey(0.75))
dwtest(Chl_a~DO+BOD+COD+SS+T_P+WT+TC+PO4_P,data=ex1_scale)
# 다중회귀분석에 대한 기본가정인 잔차(residual)에 대한 정규성, 등분산성, 독립성, 선형성 등을 만족하지 못함.
```

### Generalized Additive Model
#### scaling data 사용

```{r}
# GAM의 경우 추정되는 계수(coefficients)가 데이터의 개수보다 많으면 적합되지 않음.
m <- gam(Chl_a~s(pH)+s(DO)+s(BOD)+s(COD)+s(SS)+s(T_N)+s(T_P)+s(TOC)+s(WT)+s(EC)+s(TC)+s(NH3_N)+s(PO4_P)+s(FC)+s(Flow)+s(Rain),data=ex1_scale)
ggGam(m)
summary(m)
concurvity(m,full=TRUE) # 공선성 존재
par(mfrow=c(2,2))
gam.check(m)
par(mfrow=c(1,1))
m1 <- gam(Chl_a~s(pH)+s(DO)+s(BOD)+s(COD)+s(SS)+s(T_P)+s(WT)+s(TC)+s(PO4_P),data=ex1_scale) # 모형 m에서 유의하지 않은 변수를 제외하고 모형구축.
ggGam(m1)
summary(m1) 
concurvity(m1,full=TRUE)
par(mfrow=c(2,2))
gam.check(m1)
par(mfrow=c(1,1)) 
m2 <- gam(Chl_a~s(pH)+s(DO)+s(BOD)+s(COD)+s(SS)+s(T_P)+s(WT)+s(PO4_P),data=ex1_scale) # 모형 m1에서 유의하지 않은 변수를 제외하고 모형구축.
ggGam(m2)
summary(m2) # R-sq.(adj) =  0.686 
concurvity(m2,full=TRUE)
par(mfrow=c(2,2))
gam.check(m2)
par(mfrow=c(1,1)) 
```

#### 일반화가법모형이 다중선형회귀모형보다 설명력이 우수하다는 것을 확실하게 보여주기 위해서는 TC나 FC처럼 설명변수들과 확실한 비선형관계가 있다고 여겨지는 변수를 반응변수로 선택하는 것이 좋다고 판단됨.

### Functional Regression
#### Functional Data Analysis : 각각의 변수들이 시간에 대한 함수(function)임에 초점을 맞추어 분석하는 것

#### scaling data 사용

#### Smoothing by Fourier basis : 주기적인 데이터에 유용함

#### 기저의 개수가 많을수록 함수적 자료의 형태가 이산형 자료가 되어 편의(bias)가 줄어들고, 기저의 개수가 적을수록 평활화 정도가 커지게 되어 분산이 줄어든다. 본 데이터는 주단위자료이고 주기가 약 51이므로 기저함수의 개수를 중간정도인 25로 정함.

```{r}
daybasisfourier <- create.fourier.basis(c(0, 510), nbasis=25, period=51) 
pH.fb <- smooth.basis(argvals=1:510, ex1$pH, daybasisfourier, fdnames=list("week", "Station", "pH"))$fd
par(mfrow=c(2,1))
plot(pH.fb) ; plot(ex1$pH)
par(mfrow=c(1,1))
DO.fb <- smooth.basis(argvals=1:510, ex1$DO, daybasisfourier, fdnames=list("week", "Station", "DO"))$fd
par(mfrow=c(2,1))
plot(DO.fb) ; plot(ex1$DO)
par(mfrow=c(1,1))
BOD.fb <- smooth.basis(argvals=1:510, ex1$BOD, daybasisfourier, fdnames=list("week", "Station", "BOD"))$fd
par(mfrow=c(2,1))
plot(BOD.fb) ; plot(ex1$BOD)
par(mfrow=c(1,1))
COD.fb <- smooth.basis(argvals=1:510, ex1$COD, daybasisfourier, fdnames=list("week", "Station", "COD"))$fd
par(mfrow=c(2,1))
plot(COD.fb) ; plot(ex1$COD)
par(mfrow=c(1,1))
SS.fb <- smooth.basis(argvals=1:510, ex1$SS, daybasisfourier, fdnames=list("week", "Station", "SS"))$fd
par(mfrow=c(2,1))
plot(SS.fb) ; plot(ex1$SS)
par(mfrow=c(1,1))
T_N.fb <- smooth.basis(argvals=1:510, ex1$T_N, daybasisfourier, fdnames=list("week", "Station", "T_N"))$fd
par(mfrow=c(2,1))
plot(T_N.fb) ; plot(ex1$T_N)
par(mfrow=c(1,1))
T_P.fb <- smooth.basis(argvals=1:510, ex1$T_P, daybasisfourier, fdnames=list("week", "Station", "T_P"))$fd
par(mfrow=c(2,1))
plot(T_P.fb) ; plot(ex1$T_P)
par(mfrow=c(1,1))
TOC.fb <- smooth.basis(argvals=1:510, ex1$TOC, daybasisfourier, fdnames=list("week", "Station", "TOC"))$fd
par(mfrow=c(2,1))
plot(TOC.fb) ; plot(ex1$TOC)
par(mfrow=c(1,1))
WT.fb <- smooth.basis(argvals=1:510, ex1$WT, daybasisfourier, fdnames=list("week", "Station", "WT"))$fd
par(mfrow=c(2,1))
plot(WT.fb) ; plot(ex1$WT)
par(mfrow=c(1,1))
EC.fb <- smooth.basis(argvals=1:510, ex1$EC, daybasisfourier, fdnames=list("week", "Station", "EC"))$fd
par(mfrow=c(2,1))
plot(EC.fb) ; plot(ex1$EC)
par(mfrow=c(1,1))
TC.fb <- smooth.basis(argvals=1:510, ex1$TC, daybasisfourier, fdnames=list("week", "Station", "TC"))$fd
par(mfrow=c(2,1))
plot(TC.fb) ; plot(ex1$TC)
par(mfrow=c(1,1))
NH3_N.fb <- smooth.basis(argvals=1:510, ex1$NH3_N, daybasisfourier, fdnames=list("week", "Station", "NH3_N"))$fd
par(mfrow=c(2,1))
plot(NH3_N.fb) ; plot(ex1$NH3_N)
par(mfrow=c(1,1))
PO4_P.fb <- smooth.basis(argvals=1:510, ex1$PO4_P, daybasisfourier, fdnames=list("week", "Station", "PO4_P"))$fd
par(mfrow=c(2,1))
plot(PO4_P.fb) ; plot(ex1$PO4_P)
par(mfrow=c(1,1))
Chl_a.fb <- smooth.basis(argvals=1:510, ex1$Chl_a, daybasisfourier, fdnames=list("week", "Station", "Chl_a"))$fd
par(mfrow=c(2,1))
plot(Chl_a.fb) ; plot(ex1$Chl_a)
par(mfrow=c(1,1))
FC.fb <- smooth.basis(argvals=1:510, ex1$FC, daybasisfourier, fdnames=list("week", "Station", "FC"))$fd
par(mfrow=c(2,1))
plot(FC.fb) ; plot(ex1$FC)
par(mfrow=c(1,1))
Flow.fb <- smooth.basis(argvals=1:510, ex1$Flow, daybasisfourier, fdnames=list("week", "Station", "Flow"))$fd
par(mfrow=c(2,1))
plot(Flow.fb) ; plot(ex1$Flow)
par(mfrow=c(1,1))
Rain.fb <- smooth.basis(argvals=1:510, ex1$Rain, daybasisfourier, fdnames=list("week", "Station", "Rain"))$fd
par(mfrow=c(2,1))
plot(Rain.fb) ; plot(ex1$Rain)
par(mfrow=c(1,1))
```

#### Smoothing by B-spline basis : 비주기적인 데이터에 유용함

#### 본 데이터는 10년간 측정한 일별 주단위데이터이므로 각 년도마다 4분기로 나누어서 평활화하는 것이 바람직하다고 판단하여 부분구간의 개수를 40으로 정하고 cubic spline을 사용하였음. 이에 따라 기저함수의 개수는 3+40-1=42로 정함. 

```{r}
daybasisspline <- create.bspline.basis(c(0, 510), nbasis=42, norder=4)
pH.Bb <- smooth.basis(argvals=1:510, ex1$pH, daybasisspline, fdnames=list("week", "Station", "pH"))$fd
par(mfrow=c(2,1))
plot(pH.Bb) ; plot(ex1$pH) 
par(mfrow=c(1,1))
DO.Bb <- smooth.basis(argvals=1:510, ex1$DO, daybasisspline, fdnames=list("week", "Station", "DO"))$fd
par(mfrow=c(2,1))
plot(DO.Bb) ; plot(ex1$DO) 
par(mfrow=c(1,1))
BOD.Bb <- smooth.basis(argvals=1:510, ex1$BOD, daybasisspline, fdnames=list("week", "Station", "BOD"))$fd
par(mfrow=c(2,1))
plot(BOD.Bb) ; plot(ex1$BOD) 
par(mfrow=c(1,1))
COD.Bb <- smooth.basis(argvals=1:510, ex1$COD, daybasisspline, fdnames=list("week", "Station", "COD"))$fd
par(mfrow=c(2,1))
plot(COD.Bb) ; plot(ex1$COD) 
par(mfrow=c(1,1))
SS.Bb <- smooth.basis(argvals=1:510, ex1$SS, daybasisspline, fdnames=list("week", "Station", "SS"))$fd
par(mfrow=c(2,1))
plot(SS.Bb) ; plot(ex1$SS) 
par(mfrow=c(1,1))
T_N.Bb <- smooth.basis(argvals=1:510, ex1$T_N, daybasisspline, fdnames=list("week", "Station", "T_N"))$fd
par(mfrow=c(2,1))
plot(T_N.Bb) ; plot(ex1$T_N) 
par(mfrow=c(1,1))
T_P.Bb <- smooth.basis(argvals=1:510, ex1$T_P, daybasisspline, fdnames=list("week", "Station", "T_P"))$fd
par(mfrow=c(2,1))
plot(T_P.Bb) ; plot(ex1$T_P) 
par(mfrow=c(1,1))
TOC.Bb <- smooth.basis(argvals=1:510, ex1$TOC, daybasisspline, fdnames=list("week", "Station", "TOC"))$fd
par(mfrow=c(2,1))
plot(TOC.Bb) ; plot(ex1$TOC) 
par(mfrow=c(1,1))
WT.Bb <- smooth.basis(argvals=1:510, ex1$WT, daybasisspline, fdnames=list("week", "Station", "WT"))$fd
par(mfrow=c(2,1))
plot(WT.Bb) ; plot(ex1$WT) 
par(mfrow=c(1,1))
EC.Bb <- smooth.basis(argvals=1:510, ex1$EC, daybasisspline, fdnames=list("week", "Station", "EC"))$fd
par(mfrow=c(2,1))
plot(EC.Bb) ; plot(ex1$EC) 
par(mfrow=c(1,1))
TC.Bb <- smooth.basis(argvals=1:510, ex1$TC, daybasisspline, fdnames=list("week", "Station", "TC"))$fd
par(mfrow=c(2,1))
plot(TC.Bb) ; plot(ex1$TC) 
par(mfrow=c(1,1))
NH3_N.Bb <- smooth.basis(argvals=1:510, ex1$NH3_N, daybasisspline, fdnames=list("week", "Station", "NH3_N"))$fd
par(mfrow=c(2,1))
plot(NH3_N.Bb) ; plot(ex1$NH3_N) 
par(mfrow=c(1,1))
PO4_P.Bb <- smooth.basis(argvals=1:510, ex1$PO4_P, daybasisspline, fdnames=list("week", "Station", "PO4_P"))$fd
par(mfrow=c(2,1))
plot(PO4_P.Bb) ; plot(ex1$PO4_P) 
par(mfrow=c(1,1))
Chl_a.Bb <- smooth.basis(argvals=1:510, ex1$Chl_a, daybasisspline, fdnames=list("week", "Station", "Chl_a"))$fd
par(mfrow=c(2,1))
plot(Chl_a.Bb) ; plot(ex1$Chl_a) 
par(mfrow=c(1,1))
Chl_a.Bb <- smooth.basis(argvals=1:510, ex1$Chl_a, daybasisspline, fdnames=list("week", "Station", "Chl_a"))$fd
par(mfrow=c(2,1))
plot(Chl_a.Bb) ; plot(ex1$Chl_a) 
par(mfrow=c(1,1))
FC.Bb <- smooth.basis(argvals=1:510, ex1$FC, daybasisspline, fdnames=list("week", "Station", "FC"))$fd
par(mfrow=c(2,1))
plot(FC.Bb) ; plot(ex1$FC) 
par(mfrow=c(1,1))
Flow.Bb <- smooth.basis(argvals=1:510, ex1$Flow, daybasisspline, fdnames=list("week", "Station", "Flow"))$fd
par(mfrow=c(2,1))
plot(Flow.Bb) ; plot(ex1$Flow) 
par(mfrow=c(1,1))
Rain.Bb <- smooth.basis(argvals=1:510, ex1$Rain, daybasisspline, fdnames=list("week", "Station", "Rain"))$fd
par(mfrow=c(2,1))
plot(Rain.Bb) ; plot(ex1$Rain) 
par(mfrow=c(1,1))
```

#### 재표현 결과, Fourier basis보다는 B-spline basis 방법이 각 변수의 특성을 더 잘 설명하는 함수를 추정해주는 것으로 보여진다. 이는 비주기적인 특성이나 이상점(outlier) 등의 영향 때문인것으로 파악된다. 따라서 B-spline basis 방법으로 재표현된 결과를 가지고 함수적 회귀모형을 적합해보도록 한다. 

#### 

```{r}
Chl_a.fR <- fRegress(Chl_a.Bb ~ pH.Bb+DO.Bb+BOD.Bb+COD.Bb+SS.Bb+T_N.Bb+T_P.Bb+TOC.Bb+WT.Bb+EC.Bb+TC.Bb+NH3_N.Bb+PO4_P.Bb+FC.Bb+Flow.Bb+Rain.Bb)
```

